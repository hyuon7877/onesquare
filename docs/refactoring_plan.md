# 🔧 OneSquare 리팩토링 계획
📅 생성일: 2025-09-05

## 📊 현황 분석 요약

### 전체 통계
- **분석된 모듈:** 114개
- **총 코드 라인:** 37,075줄
- **평균 복잡도:** 22.3
- **건강도 점수:** 30/100 🔴

## 🎯 리팩토링 우선순위

### 🔴 긴급 (1단계) - 즉시 처리 필요

#### 1. 중복 폴더 정리 ✅
- **상태:** 완료
- **작업 내용:** 
  - `field_report_old` 폴더 제거 완료
  - `field_reports` 폴더만 유지

#### 2. 초고복잡도 모듈 분할

##### 2.1 Security Middleware (복잡도: 255.6)
- **파일:** `/src/apps/security/middleware.py`
- **라인 수:** 877줄
- **문제점:**
  - 단일 파일에 너무 많은 보안 로직 집중
  - 순환 복잡도 125로 매우 높음
- **리팩토링 방안:**
  ```
  security/
  ├── middleware/
  │   ├── __init__.py
  │   ├── authentication.py  (인증 관련)
  │   ├── authorization.py   (권한 관련)
  │   ├── csrf.py           (CSRF 보호)
  │   ├── rate_limiting.py  (속도 제한)
  │   └── encryption.py     (암호화)
  ```

##### 2.2 Permissions Module (복잡도: 121.2)
- **파일:** `/src/apps/auth_system/permissions.py`
- **라인 수:** 408줄
- **리팩토링 방안:**
  ```
  auth_system/
  ├── permissions/
  │   ├── __init__.py
  │   ├── base.py          (기본 권한 클래스)
  │   ├── user.py          (사용자 권한)
  │   ├── group.py         (그룹 권한)
  │   └── notion.py        (Notion 권한)
  ```

### 🟡 중요 (2단계) - 1주일 내 처리

#### 3. 중복 의존성 통합

##### 3.1 datetime 모듈 표준화 (46개 모듈)
- **작업 내용:**
  - `utils/datetime_helper.py` 생성
  - 공통 날짜/시간 함수 통합
  - 타임존 처리 표준화

##### 3.2 JSON 처리 표준화 (41개 모듈)
- **작업 내용:**
  - `utils/json_handler.py` 생성
  - Notion API 응답 처리 통합
  - 에러 핸들링 표준화

##### 3.3 Logging 표준화 (31개 모듈)
- **작업 내용:**
  - `utils/logger.py` 생성
  - 통합 로깅 설정
  - 로그 레벨 관리

### 🟢 개선 (3단계) - 2주 내 처리

#### 4. 모듈 병합

##### 4.1 중복 models.py 통합
- **유사도:** 66.0%
- **작업 내용:**
  - 공통 모델 베이스 클래스 생성
  - 중복 필드 제거
  - 상속 구조 개선

##### 4.2 중복 views.py 통합
- **유사도:** 66.7%
- **작업 내용:**
  - Generic View 활용도 높이기
  - 공통 뷰 믹스인 생성
  - 중복 로직 제거

## 📝 리팩토링 체크리스트

### 1단계: 복잡도 감소
- [ ] Security Middleware를 5개 모듈로 분할
- [ ] Permissions를 4개 모듈로 분할
- [ ] Validators를 3개 모듈로 분할
- [ ] Notion Sync를 기능별로 분할
- [ ] Photo Views를 처리 단계별로 분할

### 2단계: 의존성 최적화
- [ ] datetime_helper.py 유틸리티 생성
- [ ] json_handler.py 유틸리티 생성
- [ ] logger.py 유틸리티 생성
- [ ] decimal_helper.py 유틸리티 생성
- [ ] 각 모듈에서 공통 유틸리티 import로 변경

### 3단계: 코드 중복 제거
- [ ] 중복 models.py 병합
- [ ] 중복 views.py 병합
- [ ] 공통 데코레이터 추출
- [ ] 공통 믹스인 생성
- [ ] 테스트 코드 통합

### 4단계: 구조 개선
- [ ] apps 디렉토리 구조 재정리
- [ ] 설정 파일 모듈화
- [ ] URL 라우팅 최적화
- [ ] 정적 파일 구조 개선

## 🚀 실행 계획

### Week 1 (2025-09-05 ~ 2025-09-11)
- **Day 1-2:** Security Middleware 분할
- **Day 3-4:** Permissions & Validators 분할
- **Day 5-7:** 공통 유틸리티 생성 및 적용

### Week 2 (2025-09-12 ~ 2025-09-18)
- **Day 1-3:** 중복 모듈 병합
- **Day 4-5:** 테스트 코드 작성
- **Day 6-7:** 성능 테스트 및 최적화

## 📊 예상 개선 효과

### 정량적 개선
- **코드 라인 수:** 37,075 → ~30,000줄 (19% 감소)
- **평균 복잡도:** 22.3 → ~15.0 (33% 개선)
- **건강도 점수:** 30/100 → 75/100 (150% 향상)
- **중복 코드:** 15% → 5% 이하

### 정성적 개선
- ✅ 유지보수성 대폭 향상
- ✅ 테스트 용이성 증가
- ✅ 새 기능 추가 시간 단축
- ✅ 버그 발생률 감소
- ✅ 코드 가독성 향상

## 🛠️ 리팩토링 도구

### 자동화 스크립트
```bash
# 복잡도 분석 실행
make analyze-modules

# 모듈 의존성 확인
python scripts/check-dependencies.py

# 중복 코드 검사
python scripts/find-duplicates.py

# 리팩토링 진행률 확인
python scripts/refactoring-progress.py
```

## ⚠️ 주의사항

1. **테스트 우선:** 리팩토링 전 테스트 코드 작성
2. **단계별 진행:** 한 번에 하나씩 변경
3. **백업 필수:** 각 단계별 git 커밋
4. **성능 모니터링:** 리팩토링 후 성능 측정
5. **팀 리뷰:** 주요 변경사항 코드 리뷰

## 📈 진행 상황 추적

| 작업 | 상태 | 진행률 | 담당자 | 완료일 |
|------|------|--------|--------|--------|
| 중복 폴더 정리 | ✅ 완료 | 100% | - | 2025-09-05 |
| Security Middleware 분할 | 🔄 진행중 | 0% | - | - |
| Permissions 분할 | ⏸️ 대기 | 0% | - | - |
| 공통 유틸리티 생성 | ⏸️ 대기 | 0% | - | - |
| 중복 모듈 병합 | ⏸️ 대기 | 0% | - | - |

---

## 🔄 업데이트 이력

- **2025-09-05:** 초기 리팩토링 계획 수립
- **2025-09-05:** 중복 폴더 정리 완료

---

*이 문서는 자동 분석 도구를 통해 생성되었으며, 실제 리팩토링 시 세부사항이 조정될 수 있습니다.*