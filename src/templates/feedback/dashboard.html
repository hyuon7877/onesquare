{% extends "base.html" %}

{% block title %}í”¼ë“œë°± ì‹œìŠ¤í…œ{% endblock %}

{% block extra_head %}
<style>
.feedback-dashboard {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.feedback-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    border-left: 4px solid #007AFF;
}

.stat-value {
    font-size: 2rem;
    font-weight: bold;
    color: #007AFF;
    margin-bottom: 5px;
}

.stat-label {
    color: #666;
    font-size: 0.9rem;
}

.thread-list {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.thread-list-header {
    display: flex;
    justify-content: between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #eee;
}

.thread-item {
    display: flex;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    transition: background-color 0.2s;
}

.thread-item:hover {
    background-color: #f8f9fa;
}

.thread-item:last-child {
    border-bottom: none;
}

.thread-avatar {
    width: 50px;
    height: 50px;
    border-radius: 25px;
    background: linear-gradient(135deg, #007AFF, #34C759);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    margin-right: 15px;
    font-size: 1.2rem;
}

.thread-info {
    flex: 1;
}

.thread-title {
    font-weight: 600;
    color: #333;
    margin-bottom: 5px;
}

.thread-meta {
    display: flex;
    align-items: center;
    gap: 15px;
    color: #666;
    font-size: 0.85rem;
}

.thread-type {
    background: #007AFF;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
}

.thread-type.urgent {
    background: #FF3B30;
}

.thread-type.report {
    background: #FF9500;
}

.thread-type.general {
    background: #34C759;
}

.unread-badge {
    background: #FF3B30;
    color: white;
    border-radius: 15px;
    padding: 2px 8px;
    font-size: 0.75rem;
    min-width: 20px;
    text-align: center;
}

.fab {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 60px;
    height: 60px;
    border-radius: 30px;
    background: linear-gradient(135deg, #007AFF, #34C759);
    border: none;
    color: white;
    font-size: 1.5rem;
    box-shadow: 0 4px 20px rgba(0, 122, 255, 0.4);
    cursor: pointer;
    transition: transform 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.fab:hover {
    transform: scale(1.1);
}

.loading {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 200px;
    color: #666;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #666;
}

.empty-state-icon {
    font-size: 4rem;
    margin-bottom: 20px;
    opacity: 0.3;
}

@media (max-width: 768px) {
    .feedback-dashboard {
        padding: 10px;
    }
    
    .feedback-stats {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }
    
    .thread-item {
        padding: 12px 15px;
    }
    
    .thread-avatar {
        width: 40px;
        height: 40px;
        margin-right: 12px;
        font-size: 1rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="feedback-dashboard">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>í”¼ë“œë°± ì‹œìŠ¤í…œ</h1>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-primary btn-sm" id="filterAll">ì „ì²´</button>
            <button type="button" class="btn btn-outline-primary btn-sm" id="filterActive">í™œì„±</button>
            <button type="button" class="btn btn-outline-primary btn-sm" id="filterUnread">ì½ì§€ ì•ŠìŒ</button>
        </div>
    </div>

    <!-- í†µê³„ ì¹´ë“œë“¤ -->
    <div class="feedback-stats">
        <div class="stat-card">
            <div class="stat-value" id="totalThreads">-</div>
            <div class="stat-label">ì „ì²´ ìŠ¤ë ˆë“œ</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="activeThreads">-</div>
            <div class="stat-label">í™œì„± ìŠ¤ë ˆë“œ</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="unreadMessages">-</div>
            <div class="stat-label">ì½ì§€ ì•Šì€ ë©”ì‹œì§€</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="myThreads">-</div>
            <div class="stat-label">ë‚´ê°€ ìƒì„±í•œ ìŠ¤ë ˆë“œ</div>
        </div>
    </div>

    <!-- ìŠ¤ë ˆë“œ ëª©ë¡ -->
    <div class="thread-list">
        <div class="thread-list-header">
            <h5 class="mb-0">í”¼ë“œë°± ìŠ¤ë ˆë“œ</h5>
            <button class="btn btn-primary btn-sm" onclick="createNewThread()">
                <i class="fas fa-plus"></i> ìƒˆ ìŠ¤ë ˆë“œ
            </button>
        </div>
        
        <div id="threadListContainer">
            <div class="loading">
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">ë¡œë”© ì¤‘...</span>
                </div>
                <span class="ml-2">ìŠ¤ë ˆë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
            </div>
        </div>
    </div>
</div>

<!-- FAB -->
<button class="fab" onclick="createNewThread()" title="ìƒˆ í”¼ë“œë°± ìŠ¤ë ˆë“œ ìƒì„±">
    <i class="fas fa-plus"></i>
</button>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
    loadThreadList();
    
    // í•„í„° ë²„íŠ¼ ì´ë²¤íŠ¸
    document.getElementById('filterAll').addEventListener('click', () => loadThreadList());
    document.getElementById('filterActive').addEventListener('click', () => loadThreadList('active'));
    document.getElementById('filterUnread').addEventListener('click', () => loadThreadList(null, true));
});

async function loadDashboardData() {
    try {
        const response = await fetch('/feedback/api/threads/');
        const data = await response.json();
        
        // í†µê³„ ì—…ë°ì´íŠ¸
        updateStats(data.results || []);
    } catch (error) {
        console.error('ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
    }
}

async function loadThreadList(status = null, unreadOnly = false) {
    const container = document.getElementById('threadListContainer');
    container.innerHTML = `
        <div class="loading">
            <div class="spinner-border text-primary" role="status"></div>
            <span class="ml-2">ìŠ¤ë ˆë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
        </div>
    `;
    
    try {
        let url = '/feedback/api/threads/';
        const params = new URLSearchParams();
        
        if (status) params.append('status', status);
        if (unreadOnly) params.append('unread_only', 'true');
        
        if (params.toString()) {
            url += '?' + params.toString();
        }
        
        const response = await fetch(url);
        const data = await response.json();
        
        displayThreadList(data.results || []);
    } catch (error) {
        console.error('ìŠ¤ë ˆë“œ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">âš ï¸</div>
                <p>ìŠ¤ë ˆë“œë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                <button class="btn btn-primary" onclick="loadThreadList()">ë‹¤ì‹œ ì‹œë„</button>
            </div>
        `;
    }
}

function displayThreadList(threads) {
    const container = document.getElementById('threadListContainer');
    
    if (threads.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ’¬</div>
                <p>í”¼ë“œë°± ìŠ¤ë ˆë“œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                <button class="btn btn-primary" onclick="createNewThread()">ì²« ë²ˆì§¸ ìŠ¤ë ˆë“œ ë§Œë“¤ê¸°</button>
            </div>
        `;
        return;
    }
    
    const threadsHtml = threads.map(thread => `
        <div class="thread-item" onclick="openThread('${thread.id}')">
            <div class="thread-avatar">
                ${getThreadTypeIcon(thread.thread_type)}
            </div>
            <div class="thread-info">
                <div class="thread-title">${thread.title}</div>
                <div class="thread-meta">
                    <span class="thread-type ${thread.thread_type}">
                        ${getThreadTypeLabel(thread.thread_type)}
                    </span>
                    <span>by ${thread.creator_name}</span>
                    <span>${formatDate(thread.last_activity)}</span>
                    <span>${thread.message_count}ê°œ ë©”ì‹œì§€</span>
                </div>
            </div>
            ${thread.unread_count > 0 ? `<div class="unread-badge">${thread.unread_count}</div>` : ''}
        </div>
    `).join('');
    
    container.innerHTML = threadsHtml;
}

function updateStats(threads) {
    const totalThreads = threads.length;
    const activeThreads = threads.filter(t => t.status === 'active').length;
    const unreadMessages = threads.reduce((sum, t) => sum + (t.unread_count || 0), 0);
    const myThreads = threads.filter(t => t.creator === getCurrentUserId()).length;
    
    document.getElementById('totalThreads').textContent = totalThreads;
    document.getElementById('activeThreads').textContent = activeThreads;
    document.getElementById('unreadMessages').textContent = unreadMessages;
    document.getElementById('myThreads').textContent = myThreads;
}

function getThreadTypeIcon(type) {
    const icons = {
        'task_feedback': 'ğŸ’¼',
        'report_feedback': 'ğŸ“‹',
        'general_feedback': 'ğŸ’¬',
        'urgent_feedback': 'ğŸš¨'
    };
    return icons[type] || 'ğŸ’¬';
}

function getThreadTypeLabel(type) {
    const labels = {
        'task_feedback': 'ì—…ë¬´ í”¼ë“œë°±',
        'report_feedback': 'ë³´ê³ ì„œ í”¼ë“œë°±',
        'general_feedback': 'ì¼ë°˜ í”¼ë“œë°±',
        'urgent_feedback': 'ê¸´ê¸‰ í”¼ë“œë°±'
    };
    return labels[type] || 'ì¼ë°˜ í”¼ë“œë°±';
}

function formatDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffTime = Math.abs(now - date);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays === 1) return 'ì˜¤ëŠ˜';
    if (diffDays === 2) return 'ì–´ì œ';
    if (diffDays <= 7) return `${diffDays - 1}ì¼ ì „`;
    
    return date.toLocaleDateString('ko-KR');
}

function openThread(threadId) {
    window.location.href = `/feedback/thread/${threadId}/`;
}

function createNewThread() {
    window.location.href = '/feedback/create/';
}

function getCurrentUserId() {
    // í˜„ì¬ ì‚¬ìš©ì IDë¥¼ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜
    // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ì„¸ì…˜ì´ë‚˜ í† í°ì—ì„œ ê°€ì ¸ì™€ì•¼ í•¨
    return window.currentUserId || null;
}

// PWA ê¸°ëŠ¥: ë°±ê·¸ë¼ìš´ë“œ ë™ê¸°í™”
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.addEventListener('message', function(event) {
        if (event.data && event.data.type === 'FEEDBACK_UPDATE') {
            // ìƒˆ í”¼ë“œë°±ì´ ë„ì°©í•˜ë©´ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            loadThreadList();
            loadDashboardData();
            
            // ì•Œë¦¼ í‘œì‹œ
            showNotification('ìƒˆ í”¼ë“œë°±', 'ìƒˆ ë©”ì‹œì§€ê°€ ë„ì°©í–ˆìŠµë‹ˆë‹¤.');
        }
    });
}

function showNotification(title, body) {
    if (Notification.permission === 'granted') {
        new Notification(title, { body });
    }
}
</script>
{% endblock %}