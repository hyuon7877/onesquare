<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OneSquare 통합 캘린더 시스템</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- FullCalendar CSS -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <style>
        .calendar-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .calendar-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
            border-radius: 10px;
        }
        
        .calendar-stats {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            background: #f8f9fa;
            border-left: 4px solid #007bff;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        #calendar {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        
        /* FullCalendar 커스텀 스타일 */
        .fc-toolbar-title {
            font-size: 1.5rem !important;
            font-weight: 600;
        }
        
        .fc-button-primary {
            background-color: #007bff !important;
            border-color: #007bff !important;
        }
        
        .fc-button-primary:hover {
            background-color: #0056b3 !important;
            border-color: #004085 !important;
        }
        
        .fc-event {
            border: none !important;
            border-radius: 6px !important;
            padding: 2px 5px !important;
            font-size: 0.85rem !important;
        }
        
        .fc-event-title {
            font-weight: 500 !important;
        }
        
        /* 우선순위별 색상 */
        .priority-low {
            background-color: #28a745 !important;
        }
        
        .priority-medium {
            background-color: #007bff !important;
        }
        
        .priority-high {
            background-color: #ffc107 !important;
            color: #000 !important;
        }
        
        .priority-urgent {
            background-color: #dc3545 !important;
        }
        
        /* 반응형 */
        @media (max-width: 768px) {
            .calendar-container {
                padding: 10px;
            }
            
            .fc-toolbar {
                flex-direction: column !important;
                gap: 10px !important;
            }
            
            .fc-toolbar-chunk {
                display: flex !important;
                justify-content: center !important;
            }
        }
        
        /* 로딩 스피너 */
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 50px;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
    </style>
</head>
<body class="bg-light">
    <div class="calendar-container">
        <!-- 헤더 -->
        <div class="calendar-header text-center">
            <h1 class="display-4 mb-3">OneSquare 통합 캘린더</h1>
            <p class="lead mb-0">{{ user.get_full_name }}님의 일정 관리</p>
        </div>
        
        <!-- 통계 카드들 -->
        <div class="calendar-stats">
            <div class="row" id="calendar-stats">
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="stat-card">
                        <div class="stat-number" id="total-events">-</div>
                        <div class="stat-label">전체 일정</div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="stat-card">
                        <div class="stat-number" id="month-events">-</div>
                        <div class="stat-label">이번달 일정</div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="stat-card">
                        <div class="stat-number" id="upcoming-events">-</div>
                        <div class="stat-label">예정된 일정</div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="stat-card">
                        <div class="stat-number" id="pending-responses">-</div>
                        <div class="stat-label">응답 대기</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 액션 버튼들 -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary" id="today-btn">오늘</button>
                <button type="button" class="btn btn-outline-secondary" id="refresh-btn">새로고침</button>
            </div>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-success" id="create-event-btn">
                    <i class="fas fa-plus"></i> 새 일정
                </button>
                <a href="{% url 'calendar_system:my_events' %}" class="btn btn-info">
                    <i class="fas fa-list"></i> 내 일정
                </a>
                <a href="{% url 'calendar_system:settings' %}" class="btn btn-secondary">
                    <i class="fas fa-cog"></i> 설정
                </a>
            </div>
        </div>
        
        <!-- 로딩 스피너 -->
        <div class="loading-spinner" id="loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">로딩 중...</span>
            </div>
            <p class="mt-2 text-muted">일정을 불러오는 중...</p>
        </div>
        
        <!-- 캘린더 -->
        <div id="calendar"></div>
    </div>

    <!-- 이벤트 생성/수정 모달 -->
    <div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="eventModalLabel">새 이벤트 만들기</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="eventModalBody">
                    <!-- 폼이 AJAX로 로드됩니다 -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- 이벤트 상세보기 모달 -->
    <div class="modal fade" id="eventDetailModal" tabindex="-1" aria-labelledby="eventDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="eventDetailModalLabel">이벤트 상세</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="eventDetailModalBody">
                    <!-- 상세 정보가 AJAX로 로드됩니다 -->
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Font Awesome (아이콘용) -->
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    
    <!-- FullCalendar JS -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    
    <!-- FullCalendar 한국어 로케일 -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales/ko.global.min.js"></script>
    
    <!-- Custom JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const calendarEl = document.getElementById('calendar');
            const loadingSpinner = document.getElementById('loading-spinner');
            
            // CSRF 토큰 가져오기
            function getCSRFToken() {
                return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                       document.querySelector('meta[name=csrf-token]')?.content || '';
            }
            
            // 로딩 상태 관리
            function showLoading() {
                loadingSpinner.style.display = 'block';
                calendarEl.style.opacity = '0.5';
            }
            
            function hideLoading() {
                loadingSpinner.style.display = 'none';
                calendarEl.style.opacity = '1';
            }
            
            // FullCalendar 초기화
            const calendar = new FullCalendar.Calendar(calendarEl, {
                // 기본 설정
                locale: 'ko',
                timeZone: 'Asia/Seoul',
                
                // 초기 뷰 설정
                initialView: '{{ calendar_settings.default_view|default:"dayGridMonth" }}',
                
                // 헤더 설정
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
                },
                
                // 뷰 설정
                views: {
                    dayGridMonth: {
                        titleFormat: { year: 'numeric', month: 'long' }
                    },
                    timeGridWeek: {
                        titleFormat: { year: 'numeric', month: 'short', day: 'numeric' }
                    },
                    timeGridDay: {
                        titleFormat: { year: 'numeric', month: 'short', day: 'numeric', weekday: 'long' }
                    }
                },
                
                // 시간 설정
                slotMinTime: '{{ calendar_settings.work_start_time|default:"09:00" }}',
                slotMaxTime: '{{ calendar_settings.work_end_time|default:"18:00" }}',
                slotDuration: '00:30:00',
                slotLabelInterval: '01:00:00',
                
                // 주말 표시
                weekends: {{ calendar_settings.show_weekends|yesno:"true,false" }},
                
                // 이벤트 소스
                events: {
                    url: '{% url "calendar_system:events_api" %}',
                    method: 'GET',
                    failure: function() {
                        alert('이벤트를 불러오는데 실패했습니다.');
                        hideLoading();
                    }
                },
                
                // 이벤트 로딩 상태
                loading: function(bool) {
                    if (bool) {
                        showLoading();
                    } else {
                        hideLoading();
                    }
                },
                
                // 이벤트 클릭
                eventClick: function(info) {
                    showEventDetail(info.event.id);
                },
                
                // 날짜 클릭 (새 이벤트 생성)
                dateClick: function(info) {
                    createEventAtDate(info.date);
                },
                
                // 빈 시간 선택 (새 이벤트 생성)
                select: function(info) {
                    createEventInRange(info.start, info.end);
                },
                selectable: true,
                selectMirror: true,
                
                // 이벤트 드래그 & 드롭
                editable: true,
                eventDrop: function(info) {
                    updateEventTime(info.event.id, info.event.start, info.event.end);
                },
                
                // 이벤트 리사이즈
                eventResize: function(info) {
                    updateEventTime(info.event.id, info.event.start, info.event.end);
                },
                
                // 이벤트 렌더링
                eventDidMount: function(info) {
                    // 우선순위별 스타일 적용
                    const priority = info.event.extendedProps.priority;
                    if (priority) {
                        info.el.classList.add(`priority-${priority}`);
                    }
                    
                    // 툴팁 추가
                    info.el.title = `${info.event.title}\n${info.event.extendedProps.description || ''}`;
                },
                
                // 높이 자동 조정
                height: 'auto',
                contentHeight: 600,
                
                // 더블 클릭으로 이벤트 수정
                eventMouseEnter: function(info) {
                    info.el.style.cursor = 'pointer';
                }
            });
            
            // 캘린더 렌더링
            calendar.render();
            
            // 통계 데이터 로드
            loadCalendarStats();
            
            // 이벤트 핸들러들
            
            // 오늘 버튼
            document.getElementById('today-btn').addEventListener('click', function() {
                calendar.today();
            });
            
            // 새로고침 버튼
            document.getElementById('refresh-btn').addEventListener('click', function() {
                calendar.refetchEvents();
                loadCalendarStats();
            });
            
            // 새 일정 버튼
            document.getElementById('create-event-btn').addEventListener('click', function() {
                createEvent();
            });
            
            // 함수들
            
            // 통계 로드
            function loadCalendarStats() {
                fetch('{% url "calendar_system:stats_api" %}')
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('total-events').textContent = data.stats.total_events;
                        document.getElementById('month-events').textContent = data.stats.this_month_events;
                        document.getElementById('upcoming-events').textContent = data.stats.upcoming_events;
                        document.getElementById('pending-responses').textContent = data.stats.pending_responses;
                    })
                    .catch(error => {
                        console.error('통계 로드 실패:', error);
                    });
            }
            
            // 이벤트 생성 (기본)
            function createEvent() {
                showEventModal('{% url "calendar_system:create_event" %}', 'GET');
            }
            
            // 특정 날짜에 이벤트 생성
            function createEventAtDate(date) {
                const isoDate = date.toISOString();
                showEventModal(`{% url "calendar_system:create_event" %}?start=${isoDate}`, 'GET');
            }
            
            // 시간 범위에 이벤트 생성
            function createEventInRange(start, end) {
                const startISO = start.toISOString();
                const endISO = end.toISOString();
                showEventModal(`{% url "calendar_system:create_event" %}?start=${startISO}&end=${endISO}`, 'GET');
            }
            
            // 이벤트 상세 보기
            function showEventDetail(eventId) {
                showModal('#eventDetailModal', `{% url "calendar_system:event_detail" 0 %}`.replace('0', eventId), 'GET');
            }
            
            // 이벤트 시간 업데이트 (드래그 & 드롭)
            function updateEventTime(eventId, start, end) {
                const data = {
                    start_datetime: start.toISOString(),
                    end_datetime: end.toISOString()
                };
                
                fetch(`{% url "calendar_system:update_event_time" 0 %}`.replace('0', eventId), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('success', data.message);
                    } else {
                        showToast('error', data.message);
                        // 실패 시 원래 위치로 되돌리기
                        calendar.refetchEvents();
                    }
                })
                .catch(error => {
                    console.error('이벤트 시간 업데이트 실패:', error);
                    showToast('error', '이벤트 시간 업데이트에 실패했습니다.');
                    calendar.refetchEvents();
                });
            }
            
            // 모달 표시 (이벤트 폼용)
            function showEventModal(url, method) {
                showModal('#eventModal', url, method);
            }
            
            // 범용 모달 표시
            function showModal(modalSelector, url, method) {
                const modal = new bootstrap.Modal(document.querySelector(modalSelector));
                const modalBody = document.querySelector(`${modalSelector} .modal-body`);
                
                modalBody.innerHTML = '<div class="text-center p-3"><div class="spinner-border"></div></div>';
                modal.show();
                
                fetch(url, {
                    method: method,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.text())
                .then(html => {
                    modalBody.innerHTML = html;
                    // 폼 이벤트 리스너 추가
                    setupModalForm(modalSelector);
                })
                .catch(error => {
                    console.error('모달 로드 실패:', error);
                    modalBody.innerHTML = '<div class="alert alert-danger">로드에 실패했습니다.</div>';
                });
            }
            
            // 모달 폼 설정
            function setupModalForm(modalSelector) {
                const form = document.querySelector(`${modalSelector} form`);
                if (form) {
                    form.addEventListener('submit', function(e) {
                        e.preventDefault();
                        
                        const formData = new FormData(form);
                        
                        fetch(form.action, {
                            method: 'POST',
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: formData
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                showToast('success', data.message);
                                bootstrap.Modal.getInstance(document.querySelector(modalSelector)).hide();
                                calendar.refetchEvents();
                                loadCalendarStats();
                            } else {
                                showToast('error', data.message || '오류가 발생했습니다.');
                            }
                        })
                        .catch(error => {
                            console.error('폼 제출 실패:', error);
                            showToast('error', '폼 제출에 실패했습니다.');
                        });
                    });
                }
            }
            
            // 토스트 메시지 표시
            function showToast(type, message) {
                // 간단한 토스트 구현
                const toast = document.createElement('div');
                toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed top-0 end-0 m-3`;
                toast.style.zIndex = '9999';
                toast.textContent = message;
                
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }
            
            // 전역 이벤트 리스너
            
            // 윈도우 리사이즈 시 캘린더 크기 조정
            window.addEventListener('resize', function() {
                calendar.updateSize();
            });
            
            // ESC 키로 모달 닫기
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const openModals = document.querySelectorAll('.modal.show');
                    openModals.forEach(modal => {
                        bootstrap.Modal.getInstance(modal)?.hide();
                    });
                }
            });
        });
    </script>
</body>
</html>