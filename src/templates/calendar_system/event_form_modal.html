{% load widget_tweaks %}

<form method="post" action="{% if event %}{% url 'calendar_system:edit_event' event.id %}{% else %}{% url 'calendar_system:create_event' %}{% endif %}" id="event-form">
    {% csrf_token %}
    
    <div class="row">
        <div class="col-md-12 mb-3">
            <label for="{{ form.title.id_for_label }}" class="form-label">
                {{ form.title.label }} <span class="text-danger">*</span>
            </label>
            {{ form.title|add_class:"form-control" }}
            {% if form.title.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.title.errors.0 }}
                </div>
            {% endif %}
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-6 mb-3">
            <label for="{{ form.start_datetime.id_for_label }}" class="form-label">
                {{ form.start_datetime.label }} <span class="text-danger">*</span>
            </label>
            {{ form.start_datetime|add_class:"form-control" }}
            {% if form.start_datetime.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.start_datetime.errors.0 }}
                </div>
            {% endif %}
        </div>
        
        <div class="col-md-6 mb-3">
            <label for="{{ form.end_datetime.id_for_label }}" class="form-label">
                {{ form.end_datetime.label }} <span class="text-danger">*</span>
            </label>
            {{ form.end_datetime|add_class:"form-control" }}
            {% if form.end_datetime.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.end_datetime.errors.0 }}
                </div>
            {% endif %}
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-12 mb-3">
            <div class="form-check">
                {{ form.is_all_day|add_class:"form-check-input" }}
                <label class="form-check-label" for="{{ form.is_all_day.id_for_label }}">
                    {{ form.is_all_day.label }}
                </label>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-6 mb-3">
            <label for="{{ form.category.id_for_label }}" class="form-label">
                {{ form.category.label }}
            </label>
            {{ form.category|add_class:"form-select" }}
            {% if form.category.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.category.errors.0 }}
                </div>
            {% endif %}
        </div>
        
        <div class="col-md-6 mb-3">
            <label for="{{ form.event_type.id_for_label }}" class="form-label">
                {{ form.event_type.label }}
            </label>
            {{ form.event_type|add_class:"form-select" }}
            {% if form.event_type.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.event_type.errors.0 }}
                </div>
            {% endif %}
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-6 mb-3">
            <label for="{{ form.priority.id_for_label }}" class="form-label">
                {{ form.priority.label }}
            </label>
            {{ form.priority|add_class:"form-select" }}
            {% if form.priority.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.priority.errors.0 }}
                </div>
            {% endif %}
        </div>
        
        <div class="col-md-6 mb-3">
            <label for="{{ form.reminder_minutes.id_for_label }}" class="form-label">
                {{ form.reminder_minutes.label }}
            </label>
            {{ form.reminder_minutes|add_class:"form-control" }}
            {% if form.reminder_minutes.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.reminder_minutes.errors.0 }}
                </div>
            {% endif %}
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-12 mb-3">
            <label for="{{ form.description.id_for_label }}" class="form-label">
                {{ form.description.label }}
            </label>
            {{ form.description|add_class:"form-control" }}
            {% if form.description.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.description.errors.0 }}
                </div>
            {% endif %}
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-6 mb-3">
            <label for="{{ form.location.id_for_label }}" class="form-label">
                {{ form.location.label }}
            </label>
            {{ form.location|add_class:"form-control" }}
            {% if form.location.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.location.errors.0 }}
                </div>
            {% endif %}
        </div>
        
        <div class="col-md-6 mb-3">
            <label for="{{ form.url.id_for_label }}" class="form-label">
                {{ form.url.label }}
            </label>
            {{ form.url|add_class:"form-control" }}
            {% if form.url.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.url.errors.0 }}
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- 반복 설정 -->
    <div class="row">
        <div class="col-md-6 mb-3">
            <label for="{{ form.recurrence_type.id_for_label }}" class="form-label">
                {{ form.recurrence_type.label }}
            </label>
            {{ form.recurrence_type|add_class:"form-select" }}
            {% if form.recurrence_type.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.recurrence_type.errors.0 }}
                </div>
            {% endif %}
        </div>
        
        <div class="col-md-6 mb-3" id="recurrence_end_wrapper" style="display: none;">
            <label for="{{ form.recurrence_end_date.id_for_label }}" class="form-label">
                {{ form.recurrence_end_date.label }}
            </label>
            {{ form.recurrence_end_date|add_class:"form-control" }}
            {% if form.recurrence_end_date.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.recurrence_end_date.errors.0 }}
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- 참석자 선택 -->
    {% if form.attendee_users %}
    <div class="row">
        <div class="col-md-12 mb-3">
            <label class="form-label">{{ form.attendee_users.label }}</label>
            <div class="border rounded p-3 max-height-200 overflow-auto">
                {% for choice in form.attendee_users %}
                    <div class="form-check">
                        {{ choice.tag }}
                        <label class="form-check-label" for="{{ choice.id_for_label }}">
                            {{ choice.choice_label }}
                        </label>
                    </div>
                {% endfor %}
            </div>
            {% if form.attendee_users.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.attendee_users.errors.0 }}
                </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
    
    <!-- 폼 에러 표시 -->
    {% if form.non_field_errors %}
        <div class="alert alert-danger">
            {% for error in form.non_field_errors %}
                {{ error }}
            {% endfor %}
        </div>
    {% endif %}
    
    <!-- 버튼 -->
    <div class="d-flex justify-content-end gap-2">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
        <button type="submit" class="btn btn-primary">
            {% if event %}수정{% else %}생성{% endif %}
        </button>
    </div>
</form>

<style>
.max-height-200 {
    max-height: 200px;
}

.overflow-auto {
    overflow: auto;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('event-form');
    const allDayCheck = document.getElementById('{{ form.is_all_day.id_for_label }}');
    const startInput = document.getElementById('{{ form.start_datetime.id_for_label }}');
    const endInput = document.getElementById('{{ form.end_datetime.id_for_label }}');
    const recurrenceSelect = document.getElementById('{{ form.recurrence_type.id_for_label }}');
    const recurrenceEndWrapper = document.getElementById('recurrence_end_wrapper');
    
    // 종일 일정 체크박스 핸들러
    if (allDayCheck) {
        allDayCheck.addEventListener('change', function() {
            if (this.checked) {
                // 종일 일정: 시간 부분을 제거하고 날짜만 표시
                const startDate = startInput.value.split('T')[0];
                const endDate = endInput.value.split('T')[0];
                startInput.value = startDate + 'T00:00';
                endInput.value = endDate + 'T23:59';
            }
        });
    }
    
    // 반복 설정 변경 핸들러
    if (recurrenceSelect && recurrenceEndWrapper) {
        function toggleRecurrenceEnd() {
            const recurrenceType = recurrenceSelect.value;
            if (recurrenceType && recurrenceType !== 'none') {
                recurrenceEndWrapper.style.display = 'block';
            } else {
                recurrenceEndWrapper.style.display = 'none';
            }
        }
        
        // 초기 상태 설정
        toggleRecurrenceEnd();
        
        // 변경 시 토글
        recurrenceSelect.addEventListener('change', toggleRecurrenceEnd);
    }
    
    // 시작 시간 변경 시 종료 시간 자동 조정
    if (startInput && endInput) {
        startInput.addEventListener('change', function() {
            const start = new Date(this.value);
            const end = new Date(endInput.value);
            
            // 종료 시간이 시작 시간보다 이전이면 1시간 후로 조정
            if (end <= start) {
                const newEnd = new Date(start.getTime() + 60 * 60 * 1000); // 1시간 추가
                endInput.value = newEnd.toISOString().slice(0, 16);
            }
        });
    }
});
</script>