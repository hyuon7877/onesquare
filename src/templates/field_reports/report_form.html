{% extends 'base.html' %}
{% load static %}

{% block title %}{% if form.instance.pk %}리포트 수정{% else %}새 리포트 작성{% endif %}{% endblock %}

{% block extra_css %}
<style>
    .form-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .page-header {
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #e5e5ea;
    }
    
    .page-title {
        font-size: 28px;
        font-weight: 700;
        color: #1d1d1f;
        margin-bottom: 8px;
    }
    
    .page-subtitle {
        color: #6e6e73;
        font-size: 14px;
    }
    
    .form-section {
        background: white;
        border: 1px solid #d2d2d7;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 20px;
    }
    
    .section-title {
        font-size: 18px;
        font-weight: 600;
        color: #1d1d1f;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #1d1d1f;
        font-size: 14px;
    }
    
    .form-group label.required::after {
        content: ' *';
        color: #dc3545;
    }
    
    .form-control {
        width: 100%;
        padding: 12px;
        border: 1px solid #d2d2d7;
        border-radius: 8px;
        font-size: 14px;
        background: #fff;
        transition: border-color 0.3s;
    }
    
    .form-control:focus {
        border-color: #007AFF;
        outline: none;
        box-shadow: 0 0 0 3px rgba(0,122,255,0.1);
    }
    
    textarea.form-control {
        min-height: 120px;
        resize: vertical;
    }
    
    .form-row {
        display: flex;
        gap: 20px;
    }
    
    .form-row .form-group {
        flex: 1;
    }
    
    .location-section {
        background: #f5f5f7;
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .location-btn {
        background: #007AFF;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
    }
    
    .location-btn:hover {
        background: #0051D5;
    }
    
    .location-btn.loading {
        background: #6e6e73;
        cursor: not-allowed;
    }
    
    .location-info {
        margin-top: 12px;
        padding: 12px;
        background: white;
        border-radius: 8px;
        font-size: 13px;
        color: #424245;
        display: none;
    }
    
    .location-info.active {
        display: block;
    }
    
    .attachment-section {
        background: #f5f5f7;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .file-upload-area {
        border: 2px dashed #d2d2d7;
        border-radius: 8px;
        padding: 40px 20px;
        text-align: center;
        background: white;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .file-upload-area:hover {
        border-color: #007AFF;
        background: #f5f5f7;
    }
    
    .file-upload-area.dragover {
        border-color: #007AFF;
        background: #e3f2fd;
    }
    
    .upload-icon {
        font-size: 48px;
        color: #d2d2d7;
        margin-bottom: 12px;
    }
    
    .upload-text {
        color: #6e6e73;
        font-size: 14px;
        margin-bottom: 8px;
    }
    
    .upload-hint {
        color: #86868b;
        font-size: 12px;
    }
    
    .file-preview {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 12px;
        margin-top: 20px;
    }
    
    .file-item {
        position: relative;
        background: white;
        border: 1px solid #d2d2d7;
        border-radius: 8px;
        padding: 12px;
        text-align: center;
    }
    
    .file-item img {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-radius: 4px;
        margin-bottom: 8px;
    }
    
    .file-item .file-name {
        font-size: 12px;
        color: #424245;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .file-item .file-size {
        font-size: 11px;
        color: #86868b;
    }
    
    .file-item .remove-btn {
        position: absolute;
        top: 4px;
        right: 4px;
        background: rgba(255,255,255,0.9);
        border: 1px solid #d2d2d7;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 12px;
    }
    
    .file-item .remove-btn:hover {
        background: #ff3b30;
        color: white;
    }
    
    .form-actions {
        display: flex;
        gap: 12px;
        padding-top: 20px;
        border-top: 1px solid #e5e5ea;
    }
    
    .btn {
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 14px;
        border: none;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }
    
    .btn-primary {
        background: #007AFF;
        color: white;
    }
    
    .btn-primary:hover {
        background: #0051D5;
    }
    
    .btn-secondary {
        background: #f5f5f7;
        color: #1d1d1f;
        border: 1px solid #d2d2d7;
    }
    
    .btn-secondary:hover {
        background: #e8e8ed;
    }
    
    .btn-success {
        background: #34c759;
        color: white;
    }
    
    .btn-success:hover {
        background: #2ca147;
    }
    
    .btn-danger {
        background: #ff3b30;
        color: white;
    }
    
    .btn-danger:hover {
        background: #d32f2f;
    }
    
    .offline-indicator {
        display: none;
        background: #ffd60a;
        color: #000;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 20px;
    }
    
    .offline-indicator.active {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .error-message {
        background: #ffebee;
        color: #c62828;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
    }
    
    .error-message.active {
        display: block;
    }
    
    @media (max-width: 768px) {
        .form-row {
            flex-direction: column;
        }
        
        .form-actions {
            flex-direction: column;
        }
        
        .btn {
            width: 100%;
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="form-container">
    <div class="page-header">
        <h1 class="page-title">
            {% if form.instance.pk %}리포트 수정{% else %}새 리포트 작성{% endif %}
        </h1>
        <p class="page-subtitle">
            {% if form.instance.pk %}
                작성일: {{ form.instance.created_at|date:"Y년 m월 d일 H:i" }}
            {% else %}
                현장 상황을 상세하게 기록해주세요
            {% endif %}
        </p>
    </div>
    
    <div class="offline-indicator" id="offlineIndicator">
        <span>📱</span>
        <span>오프라인 모드 - 인터넷 연결 시 자동 동기화됩니다</span>
    </div>
    
    <div class="error-message" id="errorMessage"></div>
    
    <form method="post" id="reportForm" enctype="multipart/form-data">
        {% csrf_token %}
        
        <!-- 기본 정보 섹션 -->
        <div class="form-section">
            <h2 class="section-title">
                <span>📋</span>
                <span>기본 정보</span>
            </h2>
            
            <div class="form-group">
                <label for="title" class="required">제목</label>
                <input type="text" class="form-control" id="title" name="title" 
                       value="{{ form.instance.title }}" required>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="report_type" class="required">보고 유형</label>
                    <select class="form-control" id="report_type" name="report_type" required>
                        <option value="daily" {% if form.instance.report_type == 'daily' %}selected{% endif %}>일일보고</option>
                        <option value="incident" {% if form.instance.report_type == 'incident' %}selected{% endif %}>사고/이슈</option>
                        <option value="inspection" {% if form.instance.report_type == 'inspection' %}selected{% endif %}>점검보고</option>
                        <option value="progress" {% if form.instance.report_type == 'progress' %}selected{% endif %}>진행상황</option>
                        <option value="completion" {% if form.instance.report_type == 'completion' %}selected{% endif %}>완료보고</option>
                        <option value="other" {% if form.instance.report_type == 'other' %}selected{% endif %}>기타</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="status">상태</label>
                    <select class="form-control" id="status" name="status">
                        <option value="draft" {% if form.instance.status == 'draft' %}selected{% endif %}>임시저장</option>
                        <option value="submitted" {% if form.instance.status == 'submitted' %}selected{% endif %}>제출완료</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- 현장 정보 섹션 -->
        <div class="form-section">
            <h2 class="section-title">
                <span>🏗️</span>
                <span>현장 정보</span>
            </h2>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="project_name" class="required">프로젝트명</label>
                    <input type="text" class="form-control" id="project_name" name="project_name" 
                           value="{{ form.instance.project_name }}" required>
                </div>
                
                <div class="form-group">
                    <label for="site_name" class="required">현장명</label>
                    <input type="text" class="form-control" id="site_name" name="site_name" 
                           value="{{ form.instance.site_name }}" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="contractor">도급사</label>
                    <input type="text" class="form-control" id="contractor" name="contractor" 
                           value="{{ form.instance.contractor }}">
                </div>
                
                <div class="form-group">
                    <label for="workers_count">작업인원</label>
                    <input type="number" class="form-control" id="workers_count" name="workers_count" 
                           value="{{ form.instance.workers_count|default:0 }}" min="0">
                </div>
            </div>
            
            <div class="form-group">
                <label for="attendees">참석자 명단</label>
                <textarea class="form-control" id="attendees" name="attendees" rows="3">{{ form.instance.attendees }}</textarea>
            </div>
        </div>
        
        <!-- 위치 정보 섹션 -->
        <div class="form-section">
            <h2 class="section-title">
                <span>📍</span>
                <span>위치 정보</span>
            </h2>
            
            <div class="location-section">
                <button type="button" class="location-btn" id="getLocationBtn">
                    <span>🗺️</span>
                    <span>현재 위치 가져오기</span>
                </button>
                
                <div class="location-info" id="locationInfo">
                    <p id="locationText"></p>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="latitude">위도</label>
                    <input type="text" class="form-control" id="latitude" name="latitude" 
                           value="{{ form.instance.latitude }}" readonly>
                </div>
                
                <div class="form-group">
                    <label for="longitude">경도</label>
                    <input type="text" class="form-control" id="longitude" name="longitude" 
                           value="{{ form.instance.longitude }}" readonly>
                </div>
            </div>
            
            <div class="form-group">
                <label for="location_address">주소</label>
                <input type="text" class="form-control" id="location_address" name="location_address" 
                       value="{{ form.instance.location_address }}">
            </div>
        </div>
        
        <!-- 날씨 정보 섹션 -->
        <div class="form-section">
            <h2 class="section-title">
                <span>☁️</span>
                <span>날씨 정보</span>
            </h2>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="weather">날씨</label>
                    <select class="form-control" id="weather" name="weather">
                        <option value="">선택안함</option>
                        <option value="맑음" {% if form.instance.weather == '맑음' %}selected{% endif %}>☀️ 맑음</option>
                        <option value="구름조금" {% if form.instance.weather == '구름조금' %}selected{% endif %}>⛅ 구름조금</option>
                        <option value="흐림" {% if form.instance.weather == '흐림' %}selected{% endif %}>☁️ 흐림</option>
                        <option value="비" {% if form.instance.weather == '비' %}selected{% endif %}>🌧️ 비</option>
                        <option value="눈" {% if form.instance.weather == '눈' %}selected{% endif %}>❄️ 눈</option>
                        <option value="안개" {% if form.instance.weather == '안개' %}selected{% endif %}>🌫️ 안개</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="temperature">온도</label>
                    <input type="text" class="form-control" id="temperature" name="temperature" 
                           value="{{ form.instance.temperature }}" placeholder="예: 25℃">
                </div>
            </div>
        </div>
        
        <!-- 내용 섹션 -->
        <div class="form-section">
            <h2 class="section-title">
                <span>📝</span>
                <span>상세 내용</span>
            </h2>
            
            <div class="form-group">
                <label for="content" class="required">내용</label>
                <textarea class="form-control" id="content" name="content" rows="8" required>{{ form.instance.content }}</textarea>
            </div>
        </div>
        
        <!-- 첨부파일 섹션 -->
        <div class="form-section">
            <h2 class="section-title">
                <span>📎</span>
                <span>첨부파일</span>
            </h2>
            
            <div class="attachment-section">
                <div class="file-upload-area" id="fileUploadArea">
                    <div class="upload-icon">📁</div>
                    <div class="upload-text">파일을 드래그하거나 클릭하여 업로드</div>
                    <div class="upload-hint">이미지, 문서, 동영상 파일을 업로드할 수 있습니다</div>
                    <input type="file" id="fileInput" name="attachments" multiple accept="image/*,video/*,.pdf,.doc,.docx,.xls,.xlsx" style="display: none;">
                </div>
                
                <div class="file-preview" id="filePreview">
                    {% for attachment in form.instance.attachments.all %}
                    <div class="file-item" data-id="{{ attachment.id }}">
                        {% if attachment.file_type == 'image' and attachment.thumbnail %}
                            <img src="{{ attachment.thumbnail.url }}" alt="{{ attachment.file_name }}">
                        {% else %}
                            <div class="file-icon">📄</div>
                        {% endif %}
                        <div class="file-name">{{ attachment.file_name }}</div>
                        <div class="file-size">{{ attachment.file_size|filesizeformat }}</div>
                        <div class="remove-btn" onclick="removeFile(this)">✕</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- 폼 액션 -->
        <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="saveDraft()">
                <span>💾</span>
                <span>임시저장</span>
            </button>
            
            <button type="button" class="btn btn-primary" onclick="submitReport()">
                <span>✅</span>
                <span>제출하기</span>
            </button>
            
            {% if form.instance.pk %}
            <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                <span>🗑️</span>
                <span>삭제</span>
            </button>
            {% endif %}
            
            <a href="{% url 'field_reports:report_list' %}" class="btn btn-secondary">
                <span>↩️</span>
                <span>취소</span>
            </a>
        </div>
    </form>
</div>

<script>
// 오프라인 감지
window.addEventListener('online', updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);

function updateOnlineStatus() {
    const indicator = document.getElementById('offlineIndicator');
    if (!navigator.onLine) {
        indicator.classList.add('active');
        // 오프라인 모드에서 자동 저장 활성화
        enableOfflineMode();
    } else {
        indicator.classList.remove('active');
        // 온라인 복귀 시 동기화
        syncOfflineData();
    }
}

// 현재 위치 가져오기
document.getElementById('getLocationBtn').addEventListener('click', function() {
    const btn = this;
    const locationInfo = document.getElementById('locationInfo');
    const locationText = document.getElementById('locationText');
    
    if (!navigator.geolocation) {
        showError('이 브라우저는 위치 정보를 지원하지 않습니다.');
        return;
    }
    
    btn.classList.add('loading');
    btn.disabled = true;
    btn.innerHTML = '<span>📍</span><span>위치 확인 중...</span>';
    
    navigator.geolocation.getCurrentPosition(
        function(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            document.getElementById('latitude').value = lat.toFixed(8);
            document.getElementById('longitude').value = lng.toFixed(8);
            
            locationInfo.classList.add('active');
            locationText.textContent = `위치 정보를 성공적으로 가져왔습니다. (위도: ${lat.toFixed(6)}, 경도: ${lng.toFixed(6)})`;
            
            // 역지오코딩 (주소 가져오기)
            reverseGeocode(lat, lng);
            
            btn.classList.remove('loading');
            btn.disabled = false;
            btn.innerHTML = '<span>🗺️</span><span>위치 다시 가져오기</span>';
        },
        function(error) {
            let errorMsg = '위치 정보를 가져올 수 없습니다.';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMsg = '위치 정보 접근 권한이 거부되었습니다.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMsg = '위치 정보를 사용할 수 없습니다.';
                    break;
                case error.TIMEOUT:
                    errorMsg = '위치 정보 요청이 시간 초과되었습니다.';
                    break;
            }
            
            showError(errorMsg);
            btn.classList.remove('loading');
            btn.disabled = false;
            btn.innerHTML = '<span>🗺️</span><span>현재 위치 가져오기</span>';
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        }
    );
});

// 역지오코딩 (Nominatim OSM API 사용)
async function reverseGeocode(lat, lng) {
    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&addressdetails=1`);
        const data = await response.json();
        
        if (data.display_name) {
            document.getElementById('location_address').value = data.display_name;
        }
    } catch (error) {
        console.error('역지오코딩 실패:', error);
    }
}

// 파일 업로드 처리
const fileUploadArea = document.getElementById('fileUploadArea');
const fileInput = document.getElementById('fileInput');
const filePreview = document.getElementById('filePreview');

fileUploadArea.addEventListener('click', () => fileInput.click());

fileUploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    fileUploadArea.classList.add('dragover');
});

fileUploadArea.addEventListener('dragleave', () => {
    fileUploadArea.classList.remove('dragover');
});

fileUploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    fileUploadArea.classList.remove('dragover');
    handleFiles(e.dataTransfer.files);
});

fileInput.addEventListener('change', (e) => {
    handleFiles(e.target.files);
});

function handleFiles(files) {
    for (let file of files) {
        if (file.size > 10 * 1024 * 1024) { // 10MB 제한
            showError(`${file.name}은 10MB를 초과합니다.`);
            continue;
        }
        
        const fileItem = document.createElement('div');
        fileItem.classList.add('file-item');
        
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                fileItem.innerHTML = `
                    <img src="${e.target.result}" alt="${file.name}">
                    <div class="file-name">${file.name}</div>
                    <div class="file-size">${formatFileSize(file.size)}</div>
                    <div class="remove-btn" onclick="removeFile(this)">✕</div>
                `;
            };
            reader.readAsDataURL(file);
        } else {
            fileItem.innerHTML = `
                <div class="file-icon">📄</div>
                <div class="file-name">${file.name}</div>
                <div class="file-size">${formatFileSize(file.size)}</div>
                <div class="remove-btn" onclick="removeFile(this)">✕</div>
            `;
        }
        
        filePreview.appendChild(fileItem);
    }
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

function removeFile(btn) {
    btn.parentElement.remove();
}

// 임시저장
function saveDraft() {
    document.getElementById('status').value = 'draft';
    document.getElementById('reportForm').submit();
}

// 제출하기
function submitReport() {
    if (confirm('리포트를 제출하시겠습니까?\n제출 후에는 수정이 제한됩니다.')) {
        document.getElementById('status').value = 'submitted';
        document.getElementById('reportForm').submit();
    }
}

// 삭제 확인
function confirmDelete() {
    if (confirm('정말로 이 리포트를 삭제하시겠습니까?\n이 작업은 되돌릴 수 없습니다.')) {
        window.location.href = "{% if form.instance.pk %}{% url 'field_reports:report_delete' form.instance.pk %}{% endif %}";
    }
}

// 에러 메시지 표시
function showError(message) {
    const errorElement = document.getElementById('errorMessage');
    errorElement.textContent = message;
    errorElement.classList.add('active');
    setTimeout(() => {
        errorElement.classList.remove('active');
    }, 5000);
}

// 오프라인 모드 활성화
function enableOfflineMode() {
    // Service Worker가 있다면 오프라인 저장 활성화
    if ('serviceWorker' in navigator) {
        // 폼 데이터를 로컬스토리지에 자동 저장
        setInterval(saveFormToLocal, 30000); // 30초마다
    }
}

// 폼 데이터 로컬 저장
function saveFormToLocal() {
    const formData = new FormData(document.getElementById('reportForm'));
    const data = {};
    formData.forEach((value, key) => {
        data[key] = value;
    });
    
    localStorage.setItem('draft_report', JSON.stringify({
        data: data,
        timestamp: new Date().toISOString()
    }));
}

// 오프라인 데이터 동기화
async function syncOfflineData() {
    const draft = localStorage.getItem('draft_report');
    if (draft && navigator.onLine) {
        const { data, timestamp } = JSON.parse(draft);
        
        try {
            const response = await fetch('/field-reports/offline/save/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                localStorage.removeItem('draft_report');
                showToast('오프라인 데이터가 동기화되었습니다.', 'success');
            }
        } catch (error) {
            console.error('동기화 실패:', error);
        }
    }
}

function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

// 페이지 로드 시 실행
document.addEventListener('DOMContentLoaded', function() {
    updateOnlineStatus();
    
    // 로컬 스토리지에서 임시 저장 데이터 복원
    const draft = localStorage.getItem('draft_report');
    if (draft && !document.getElementById('reportForm').dataset.editing) {
        const { data } = JSON.parse(draft);
        if (confirm('임시 저장된 데이터가 있습니다. 복원하시겠습니까?')) {
            Object.keys(data).forEach(key => {
                const field = document.querySelector(`[name="${key}"]`);
                if (field) field.value = data[key];
            });
        }
    }
});
</script>
{% endblock %}