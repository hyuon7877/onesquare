{% extends 'base.html' %}
{% load static %}

{% block title %}{% if form.instance.pk %}ë¦¬í¬íŠ¸ ìˆ˜ì •{% else %}ìƒˆ ë¦¬í¬íŠ¸ ì‘ì„±{% endif %}{% endblock %}

{% block extra_css %}
<style>
    .form-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .page-header {
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #e5e5ea;
    }
    
    .page-title {
        font-size: 28px;
        font-weight: 700;
        color: #1d1d1f;
        margin-bottom: 8px;
    }
    
    .page-subtitle {
        color: #6e6e73;
        font-size: 14px;
    }
    
    .form-section {
        background: white;
        border: 1px solid #d2d2d7;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 20px;
    }
    
    .section-title {
        font-size: 18px;
        font-weight: 600;
        color: #1d1d1f;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #1d1d1f;
        font-size: 14px;
    }
    
    .form-group label.required::after {
        content: ' *';
        color: #dc3545;
    }
    
    .form-control {
        width: 100%;
        padding: 12px;
        border: 1px solid #d2d2d7;
        border-radius: 8px;
        font-size: 14px;
        background: #fff;
        transition: border-color 0.3s;
    }
    
    .form-control:focus {
        border-color: #007AFF;
        outline: none;
        box-shadow: 0 0 0 3px rgba(0,122,255,0.1);
    }
    
    textarea.form-control {
        min-height: 120px;
        resize: vertical;
    }
    
    .form-row {
        display: flex;
        gap: 20px;
    }
    
    .form-row .form-group {
        flex: 1;
    }
    
    .location-section {
        background: #f5f5f7;
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .location-btn {
        background: #007AFF;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
    }
    
    .location-btn:hover {
        background: #0051D5;
    }
    
    .location-btn.loading {
        background: #6e6e73;
        cursor: not-allowed;
    }
    
    .location-info {
        margin-top: 12px;
        padding: 12px;
        background: white;
        border-radius: 8px;
        font-size: 13px;
        color: #424245;
        display: none;
    }
    
    .location-info.active {
        display: block;
    }
    
    .attachment-section {
        background: #f5f5f7;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .file-upload-area {
        border: 2px dashed #d2d2d7;
        border-radius: 8px;
        padding: 40px 20px;
        text-align: center;
        background: white;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .file-upload-area:hover {
        border-color: #007AFF;
        background: #f5f5f7;
    }
    
    .file-upload-area.dragover {
        border-color: #007AFF;
        background: #e3f2fd;
    }
    
    .upload-icon {
        font-size: 48px;
        color: #d2d2d7;
        margin-bottom: 12px;
    }
    
    .upload-text {
        color: #6e6e73;
        font-size: 14px;
        margin-bottom: 8px;
    }
    
    .upload-hint {
        color: #86868b;
        font-size: 12px;
    }
    
    .file-preview {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 12px;
        margin-top: 20px;
    }
    
    .file-item {
        position: relative;
        background: white;
        border: 1px solid #d2d2d7;
        border-radius: 8px;
        padding: 12px;
        text-align: center;
    }
    
    .file-item img {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-radius: 4px;
        margin-bottom: 8px;
    }
    
    .file-item .file-name {
        font-size: 12px;
        color: #424245;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .file-item .file-size {
        font-size: 11px;
        color: #86868b;
    }
    
    .file-item .remove-btn {
        position: absolute;
        top: 4px;
        right: 4px;
        background: rgba(255,255,255,0.9);
        border: 1px solid #d2d2d7;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 12px;
    }
    
    .file-item .remove-btn:hover {
        background: #ff3b30;
        color: white;
    }
    
    .form-actions {
        display: flex;
        gap: 12px;
        padding-top: 20px;
        border-top: 1px solid #e5e5ea;
    }
    
    .btn {
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 14px;
        border: none;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }
    
    .btn-primary {
        background: #007AFF;
        color: white;
    }
    
    .btn-primary:hover {
        background: #0051D5;
    }
    
    .btn-secondary {
        background: #f5f5f7;
        color: #1d1d1f;
        border: 1px solid #d2d2d7;
    }
    
    .btn-secondary:hover {
        background: #e8e8ed;
    }
    
    .btn-success {
        background: #34c759;
        color: white;
    }
    
    .btn-success:hover {
        background: #2ca147;
    }
    
    .btn-danger {
        background: #ff3b30;
        color: white;
    }
    
    .btn-danger:hover {
        background: #d32f2f;
    }
    
    .offline-indicator {
        display: none;
        background: #ffd60a;
        color: #000;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 20px;
    }
    
    .offline-indicator.active {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .error-message {
        background: #ffebee;
        color: #c62828;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
    }
    
    .error-message.active {
        display: block;
    }
    
    @media (max-width: 768px) {
        .form-row {
            flex-direction: column;
        }
        
        .form-actions {
            flex-direction: column;
        }
        
        .btn {
            width: 100%;
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="form-container">
    <div class="page-header">
        <h1 class="page-title">
            {% if form.instance.pk %}ë¦¬í¬íŠ¸ ìˆ˜ì •{% else %}ìƒˆ ë¦¬í¬íŠ¸ ì‘ì„±{% endif %}
        </h1>
        <p class="page-subtitle">
            {% if form.instance.pk %}
                ì‘ì„±ì¼: {{ form.instance.created_at|date:"Yë…„ mì›” dì¼ H:i" }}
            {% else %}
                í˜„ì¥ ìƒí™©ì„ ìƒì„¸í•˜ê²Œ ê¸°ë¡í•´ì£¼ì„¸ìš”
            {% endif %}
        </p>
    </div>
    
    <div class="offline-indicator" id="offlineIndicator">
        <span>ğŸ“±</span>
        <span>ì˜¤í”„ë¼ì¸ ëª¨ë“œ - ì¸í„°ë„· ì—°ê²° ì‹œ ìë™ ë™ê¸°í™”ë©ë‹ˆë‹¤</span>
    </div>
    
    <div class="error-message" id="errorMessage"></div>
    
    <form method="post" id="reportForm" enctype="multipart/form-data">
        {% csrf_token %}
        
        <!-- ê¸°ë³¸ ì •ë³´ ì„¹ì…˜ -->
        <div class="form-section">
            <h2 class="section-title">
                <span>ğŸ“‹</span>
                <span>ê¸°ë³¸ ì •ë³´</span>
            </h2>
            
            <div class="form-group">
                <label for="title" class="required">ì œëª©</label>
                <input type="text" class="form-control" id="title" name="title" 
                       value="{{ form.instance.title }}" required>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="report_type" class="required">ë³´ê³  ìœ í˜•</label>
                    <select class="form-control" id="report_type" name="report_type" required>
                        <option value="daily" {% if form.instance.report_type == 'daily' %}selected{% endif %}>ì¼ì¼ë³´ê³ </option>
                        <option value="incident" {% if form.instance.report_type == 'incident' %}selected{% endif %}>ì‚¬ê³ /ì´ìŠˆ</option>
                        <option value="inspection" {% if form.instance.report_type == 'inspection' %}selected{% endif %}>ì ê²€ë³´ê³ </option>
                        <option value="progress" {% if form.instance.report_type == 'progress' %}selected{% endif %}>ì§„í–‰ìƒí™©</option>
                        <option value="completion" {% if form.instance.report_type == 'completion' %}selected{% endif %}>ì™„ë£Œë³´ê³ </option>
                        <option value="other" {% if form.instance.report_type == 'other' %}selected{% endif %}>ê¸°íƒ€</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="status">ìƒíƒœ</label>
                    <select class="form-control" id="status" name="status">
                        <option value="draft" {% if form.instance.status == 'draft' %}selected{% endif %}>ì„ì‹œì €ì¥</option>
                        <option value="submitted" {% if form.instance.status == 'submitted' %}selected{% endif %}>ì œì¶œì™„ë£Œ</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- í˜„ì¥ ì •ë³´ ì„¹ì…˜ -->
        <div class="form-section">
            <h2 class="section-title">
                <span>ğŸ—ï¸</span>
                <span>í˜„ì¥ ì •ë³´</span>
            </h2>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="project_name" class="required">í”„ë¡œì íŠ¸ëª…</label>
                    <input type="text" class="form-control" id="project_name" name="project_name" 
                           value="{{ form.instance.project_name }}" required>
                </div>
                
                <div class="form-group">
                    <label for="site_name" class="required">í˜„ì¥ëª…</label>
                    <input type="text" class="form-control" id="site_name" name="site_name" 
                           value="{{ form.instance.site_name }}" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="contractor">ë„ê¸‰ì‚¬</label>
                    <input type="text" class="form-control" id="contractor" name="contractor" 
                           value="{{ form.instance.contractor }}">
                </div>
                
                <div class="form-group">
                    <label for="workers_count">ì‘ì—…ì¸ì›</label>
                    <input type="number" class="form-control" id="workers_count" name="workers_count" 
                           value="{{ form.instance.workers_count|default:0 }}" min="0">
                </div>
            </div>
            
            <div class="form-group">
                <label for="attendees">ì°¸ì„ì ëª…ë‹¨</label>
                <textarea class="form-control" id="attendees" name="attendees" rows="3">{{ form.instance.attendees }}</textarea>
            </div>
        </div>
        
        <!-- ìœ„ì¹˜ ì •ë³´ ì„¹ì…˜ -->
        <div class="form-section">
            <h2 class="section-title">
                <span>ğŸ“</span>
                <span>ìœ„ì¹˜ ì •ë³´</span>
            </h2>
            
            <div class="location-section">
                <button type="button" class="location-btn" id="getLocationBtn">
                    <span>ğŸ—ºï¸</span>
                    <span>í˜„ì¬ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°</span>
                </button>
                
                <div class="location-info" id="locationInfo">
                    <p id="locationText"></p>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="latitude">ìœ„ë„</label>
                    <input type="text" class="form-control" id="latitude" name="latitude" 
                           value="{{ form.instance.latitude }}" readonly>
                </div>
                
                <div class="form-group">
                    <label for="longitude">ê²½ë„</label>
                    <input type="text" class="form-control" id="longitude" name="longitude" 
                           value="{{ form.instance.longitude }}" readonly>
                </div>
            </div>
            
            <div class="form-group">
                <label for="location_address">ì£¼ì†Œ</label>
                <input type="text" class="form-control" id="location_address" name="location_address" 
                       value="{{ form.instance.location_address }}">
            </div>
        </div>
        
        <!-- ë‚ ì”¨ ì •ë³´ ì„¹ì…˜ -->
        <div class="form-section">
            <h2 class="section-title">
                <span>â˜ï¸</span>
                <span>ë‚ ì”¨ ì •ë³´</span>
            </h2>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="weather">ë‚ ì”¨</label>
                    <select class="form-control" id="weather" name="weather">
                        <option value="">ì„ íƒì•ˆí•¨</option>
                        <option value="ë§‘ìŒ" {% if form.instance.weather == 'ë§‘ìŒ' %}selected{% endif %}>â˜€ï¸ ë§‘ìŒ</option>
                        <option value="êµ¬ë¦„ì¡°ê¸ˆ" {% if form.instance.weather == 'êµ¬ë¦„ì¡°ê¸ˆ' %}selected{% endif %}>â›… êµ¬ë¦„ì¡°ê¸ˆ</option>
                        <option value="íë¦¼" {% if form.instance.weather == 'íë¦¼' %}selected{% endif %}>â˜ï¸ íë¦¼</option>
                        <option value="ë¹„" {% if form.instance.weather == 'ë¹„' %}selected{% endif %}>ğŸŒ§ï¸ ë¹„</option>
                        <option value="ëˆˆ" {% if form.instance.weather == 'ëˆˆ' %}selected{% endif %}>â„ï¸ ëˆˆ</option>
                        <option value="ì•ˆê°œ" {% if form.instance.weather == 'ì•ˆê°œ' %}selected{% endif %}>ğŸŒ«ï¸ ì•ˆê°œ</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="temperature">ì˜¨ë„</label>
                    <input type="text" class="form-control" id="temperature" name="temperature" 
                           value="{{ form.instance.temperature }}" placeholder="ì˜ˆ: 25â„ƒ">
                </div>
            </div>
        </div>
        
        <!-- ë‚´ìš© ì„¹ì…˜ -->
        <div class="form-section">
            <h2 class="section-title">
                <span>ğŸ“</span>
                <span>ìƒì„¸ ë‚´ìš©</span>
            </h2>
            
            <div class="form-group">
                <label for="content" class="required">ë‚´ìš©</label>
                <textarea class="form-control" id="content" name="content" rows="8" required>{{ form.instance.content }}</textarea>
            </div>
        </div>
        
        <!-- ì²¨ë¶€íŒŒì¼ ì„¹ì…˜ -->
        <div class="form-section">
            <h2 class="section-title">
                <span>ğŸ“</span>
                <span>ì²¨ë¶€íŒŒì¼</span>
            </h2>
            
            <div class="attachment-section">
                <div class="file-upload-area" id="fileUploadArea">
                    <div class="upload-icon">ğŸ“</div>
                    <div class="upload-text">íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</div>
                    <div class="upload-hint">ì´ë¯¸ì§€, ë¬¸ì„œ, ë™ì˜ìƒ íŒŒì¼ì„ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>
                    <input type="file" id="fileInput" name="attachments" multiple accept="image/*,video/*,.pdf,.doc,.docx,.xls,.xlsx" style="display: none;">
                </div>
                
                <div class="file-preview" id="filePreview">
                    {% for attachment in form.instance.attachments.all %}
                    <div class="file-item" data-id="{{ attachment.id }}">
                        {% if attachment.file_type == 'image' and attachment.thumbnail %}
                            <img src="{{ attachment.thumbnail.url }}" alt="{{ attachment.file_name }}">
                        {% else %}
                            <div class="file-icon">ğŸ“„</div>
                        {% endif %}
                        <div class="file-name">{{ attachment.file_name }}</div>
                        <div class="file-size">{{ attachment.file_size|filesizeformat }}</div>
                        <div class="remove-btn" onclick="removeFile(this)">âœ•</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- í¼ ì•¡ì…˜ -->
        <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="saveDraft()">
                <span>ğŸ’¾</span>
                <span>ì„ì‹œì €ì¥</span>
            </button>
            
            <button type="button" class="btn btn-primary" onclick="submitReport()">
                <span>âœ…</span>
                <span>ì œì¶œí•˜ê¸°</span>
            </button>
            
            {% if form.instance.pk %}
            <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                <span>ğŸ—‘ï¸</span>
                <span>ì‚­ì œ</span>
            </button>
            {% endif %}
            
            <a href="{% url 'field_reports:report_list' %}" class="btn btn-secondary">
                <span>â†©ï¸</span>
                <span>ì·¨ì†Œ</span>
            </a>
        </div>
    </form>
</div>

<script>
// ì˜¤í”„ë¼ì¸ ê°ì§€
window.addEventListener('online', updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);

function updateOnlineStatus() {
    const indicator = document.getElementById('offlineIndicator');
    if (!navigator.onLine) {
        indicator.classList.add('active');
        // ì˜¤í”„ë¼ì¸ ëª¨ë“œì—ì„œ ìë™ ì €ì¥ í™œì„±í™”
        enableOfflineMode();
    } else {
        indicator.classList.remove('active');
        // ì˜¨ë¼ì¸ ë³µê·€ ì‹œ ë™ê¸°í™”
        syncOfflineData();
    }
}

// í˜„ì¬ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
document.getElementById('getLocationBtn').addEventListener('click', function() {
    const btn = this;
    const locationInfo = document.getElementById('locationInfo');
    const locationText = document.getElementById('locationText');
    
    if (!navigator.geolocation) {
        showError('ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
    }
    
    btn.classList.add('loading');
    btn.disabled = true;
    btn.innerHTML = '<span>ğŸ“</span><span>ìœ„ì¹˜ í™•ì¸ ì¤‘...</span>';
    
    navigator.geolocation.getCurrentPosition(
        function(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            document.getElementById('latitude').value = lat.toFixed(8);
            document.getElementById('longitude').value = lng.toFixed(8);
            
            locationInfo.classList.add('active');
            locationText.textContent = `ìœ„ì¹˜ ì •ë³´ë¥¼ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤. (ìœ„ë„: ${lat.toFixed(6)}, ê²½ë„: ${lng.toFixed(6)})`;
            
            // ì—­ì§€ì˜¤ì½”ë”© (ì£¼ì†Œ ê°€ì ¸ì˜¤ê¸°)
            reverseGeocode(lat, lng);
            
            btn.classList.remove('loading');
            btn.disabled = false;
            btn.innerHTML = '<span>ğŸ—ºï¸</span><span>ìœ„ì¹˜ ë‹¤ì‹œ ê°€ì ¸ì˜¤ê¸°</span>';
        },
        function(error) {
            let errorMsg = 'ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMsg = 'ìœ„ì¹˜ ì •ë³´ ì ‘ê·¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMsg = 'ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                    break;
                case error.TIMEOUT:
                    errorMsg = 'ìœ„ì¹˜ ì •ë³´ ìš”ì²­ì´ ì‹œê°„ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.';
                    break;
            }
            
            showError(errorMsg);
            btn.classList.remove('loading');
            btn.disabled = false;
            btn.innerHTML = '<span>ğŸ—ºï¸</span><span>í˜„ì¬ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°</span>';
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        }
    );
});

// ì—­ì§€ì˜¤ì½”ë”© (Nominatim OSM API ì‚¬ìš©)
async function reverseGeocode(lat, lng) {
    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&addressdetails=1`);
        const data = await response.json();
        
        if (data.display_name) {
            document.getElementById('location_address').value = data.display_name;
        }
    } catch (error) {
        console.error('ì—­ì§€ì˜¤ì½”ë”© ì‹¤íŒ¨:', error);
    }
}

// íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
const fileUploadArea = document.getElementById('fileUploadArea');
const fileInput = document.getElementById('fileInput');
const filePreview = document.getElementById('filePreview');

fileUploadArea.addEventListener('click', () => fileInput.click());

fileUploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    fileUploadArea.classList.add('dragover');
});

fileUploadArea.addEventListener('dragleave', () => {
    fileUploadArea.classList.remove('dragover');
});

fileUploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    fileUploadArea.classList.remove('dragover');
    handleFiles(e.dataTransfer.files);
});

fileInput.addEventListener('change', (e) => {
    handleFiles(e.target.files);
});

function handleFiles(files) {
    for (let file of files) {
        if (file.size > 10 * 1024 * 1024) { // 10MB ì œí•œ
            showError(`${file.name}ì€ 10MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.`);
            continue;
        }
        
        const fileItem = document.createElement('div');
        fileItem.classList.add('file-item');
        
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                fileItem.innerHTML = `
                    <img src="${e.target.result}" alt="${file.name}">
                    <div class="file-name">${file.name}</div>
                    <div class="file-size">${formatFileSize(file.size)}</div>
                    <div class="remove-btn" onclick="removeFile(this)">âœ•</div>
                `;
            };
            reader.readAsDataURL(file);
        } else {
            fileItem.innerHTML = `
                <div class="file-icon">ğŸ“„</div>
                <div class="file-name">${file.name}</div>
                <div class="file-size">${formatFileSize(file.size)}</div>
                <div class="remove-btn" onclick="removeFile(this)">âœ•</div>
            `;
        }
        
        filePreview.appendChild(fileItem);
    }
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

function removeFile(btn) {
    btn.parentElement.remove();
}

// ì„ì‹œì €ì¥
function saveDraft() {
    document.getElementById('status').value = 'draft';
    document.getElementById('reportForm').submit();
}

// ì œì¶œí•˜ê¸°
function submitReport() {
    if (confirm('ë¦¬í¬íŠ¸ë¥¼ ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì œì¶œ í›„ì—ëŠ” ìˆ˜ì •ì´ ì œí•œë©ë‹ˆë‹¤.')) {
        document.getElementById('status').value = 'submitted';
        document.getElementById('reportForm').submit();
    }
}

// ì‚­ì œ í™•ì¸
function confirmDelete() {
    if (confirm('ì •ë§ë¡œ ì´ ë¦¬í¬íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        window.location.href = "{% if form.instance.pk %}{% url 'field_reports:report_delete' form.instance.pk %}{% endif %}";
    }
}

// ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
function showError(message) {
    const errorElement = document.getElementById('errorMessage');
    errorElement.textContent = message;
    errorElement.classList.add('active');
    setTimeout(() => {
        errorElement.classList.remove('active');
    }, 5000);
}

// ì˜¤í”„ë¼ì¸ ëª¨ë“œ í™œì„±í™”
function enableOfflineMode() {
    // Service Workerê°€ ìˆë‹¤ë©´ ì˜¤í”„ë¼ì¸ ì €ì¥ í™œì„±í™”
    if ('serviceWorker' in navigator) {
        // í¼ ë°ì´í„°ë¥¼ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ìë™ ì €ì¥
        setInterval(saveFormToLocal, 30000); // 30ì´ˆë§ˆë‹¤
    }
}

// í¼ ë°ì´í„° ë¡œì»¬ ì €ì¥
function saveFormToLocal() {
    const formData = new FormData(document.getElementById('reportForm'));
    const data = {};
    formData.forEach((value, key) => {
        data[key] = value;
    });
    
    localStorage.setItem('draft_report', JSON.stringify({
        data: data,
        timestamp: new Date().toISOString()
    }));
}

// ì˜¤í”„ë¼ì¸ ë°ì´í„° ë™ê¸°í™”
async function syncOfflineData() {
    const draft = localStorage.getItem('draft_report');
    if (draft && navigator.onLine) {
        const { data, timestamp } = JSON.parse(draft);
        
        try {
            const response = await fetch('/field-reports/offline/save/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                localStorage.removeItem('draft_report');
                showToast('ì˜¤í”„ë¼ì¸ ë°ì´í„°ê°€ ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            }
        } catch (error) {
            console.error('ë™ê¸°í™” ì‹¤íŒ¨:', error);
        }
    }
}

function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
document.addEventListener('DOMContentLoaded', function() {
    updateOnlineStatus();
    
    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì„ì‹œ ì €ì¥ ë°ì´í„° ë³µì›
    const draft = localStorage.getItem('draft_report');
    if (draft && !document.getElementById('reportForm').dataset.editing) {
        const { data } = JSON.parse(draft);
        if (confirm('ì„ì‹œ ì €ì¥ëœ ë°ì´í„°ê°€ ìˆìŠµë‹ˆë‹¤. ë³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            Object.keys(data).forEach(key => {
                const field = document.querySelector(`[name="${key}"]`);
                if (field) field.value = data[key];
            });
        }
    }
});
</script>
{% endblock %}