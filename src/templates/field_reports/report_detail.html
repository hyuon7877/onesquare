{% extends 'base.html' %}
{% load static %}

{% block title %}{{ report.title }} - ÌòÑÏû• Î¶¨Ìè¨Ìä∏{% endblock %}

{% block extra_css %}
<style>
    .detail-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .report-header {
        background: white;
        border: 1px solid #d2d2d7;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 20px;
    }
    
    .report-title {
        font-size: 28px;
        font-weight: 700;
        color: #1d1d1f;
        margin-bottom: 12px;
    }
    
    .report-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        padding-top: 12px;
        border-top: 1px solid #e5e5ea;
    }
    
    .meta-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: #6e6e73;
    }
    
    .meta-item strong {
        color: #1d1d1f;
    }
    
    .status-badge {
        display: inline-block;
        padding: 6px 16px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
    }
    
    .status-draft {
        background: #f0f0f5;
        color: #6e6e73;
    }
    
    .status-submitted {
        background: #e3f2fd;
        color: #1976d2;
    }
    
    .status-synced {
        background: #f3e5f5;
        color: #7b1fa2;
    }
    
    .status-approved {
        background: #e8f5e9;
        color: #2e7d32;
    }
    
    .status-rejected {
        background: #ffebee;
        color: #c62828;
    }
    
    .report-type-badge {
        display: inline-block;
        padding: 6px 12px;
        background: #ffd60a;
        color: #000;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .action-buttons {
        display: flex;
        gap: 12px;
        margin-top: 20px;
    }
    
    .btn {
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 14px;
        border: none;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
    }
    
    .btn-primary {
        background: #007AFF;
        color: white;
    }
    
    .btn-primary:hover {
        background: #0051D5;
        transform: translateY(-2px);
    }
    
    .btn-secondary {
        background: #f5f5f7;
        color: #1d1d1f;
        border: 1px solid #d2d2d7;
    }
    
    .btn-secondary:hover {
        background: #e8e8ed;
    }
    
    .btn-danger {
        background: #ff3b30;
        color: white;
    }
    
    .btn-danger:hover {
        background: #d32f2f;
    }
    
    .btn-success {
        background: #34c759;
        color: white;
    }
    
    .btn-success:hover {
        background: #2ca147;
    }
    
    .content-section {
        background: white;
        border: 1px solid #d2d2d7;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 20px;
    }
    
    .section-title {
        font-size: 18px;
        font-weight: 600;
        color: #1d1d1f;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 16px;
    }
    
    .info-item {
        padding: 12px;
        background: #f5f5f7;
        border-radius: 8px;
    }
    
    .info-label {
        font-size: 12px;
        color: #6e6e73;
        margin-bottom: 4px;
        text-transform: uppercase;
        font-weight: 600;
    }
    
    .info-value {
        font-size: 14px;
        color: #1d1d1f;
    }
    
    .content-text {
        color: #424245;
        line-height: 1.6;
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    
    .location-map {
        height: 300px;
        background: #f5f5f7;
        border-radius: 8px;
        margin-top: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6e6e73;
    }
    
    .attachments-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 16px;
        margin-top: 16px;
    }
    
    .attachment-item {
        background: #f5f5f7;
        border: 1px solid #d2d2d7;
        border-radius: 8px;
        overflow: hidden;
        transition: all 0.3s;
        cursor: pointer;
    }
    
    .attachment-item:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    
    .attachment-image {
        width: 100%;
        height: 150px;
        object-fit: cover;
    }
    
    .attachment-info {
        padding: 12px;
    }
    
    .attachment-name {
        font-size: 13px;
        color: #1d1d1f;
        margin-bottom: 4px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .attachment-size {
        font-size: 11px;
        color: #6e6e73;
    }
    
    .review-section {
        background: #f5f5f7;
        border-left: 4px solid #007AFF;
        padding: 16px;
        border-radius: 8px;
        margin-top: 16px;
    }
    
    .review-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }
    
    .review-title {
        font-weight: 600;
        color: #1d1d1f;
    }
    
    .review-meta {
        font-size: 12px;
        color: #6e6e73;
    }
    
    .review-comment {
        color: #424245;
        line-height: 1.5;
    }
    
    .offline-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 12px;
        background: #ffd60a;
        color: #000;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .sync-status {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 12px;
        background: #e3f2fd;
        color: #1976d2;
        border-radius: 6px;
        font-size: 12px;
    }
    
    .notion-sync {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 12px;
        background: #000;
        color: #fff;
        border-radius: 6px;
        font-size: 12px;
    }
    
    @media (max-width: 768px) {
        .report-meta {
            flex-direction: column;
            gap: 8px;
        }
        
        .action-buttons {
            flex-direction: column;
        }
        
        .btn {
            width: 100%;
            justify-content: center;
        }
        
        .info-grid {
            grid-template-columns: 1fr;
        }
    }
    
    @media print {
        .action-buttons {
            display: none;
        }
        
        .detail-container {
            max-width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="detail-container">
    <!-- Î¶¨Ìè¨Ìä∏ Ìó§Îçî -->
    <div class="report-header">
        <h1 class="report-title">{{ report.title }}</h1>
        
        <div class="report-meta">
            <div class="meta-item">
                <span class="report-type-badge">{{ report.get_report_type_display }}</span>
            </div>
            
            <div class="meta-item">
                <span class="status-badge status-{{ report.status }}">
                    {{ report.get_status_display }}
                </span>
            </div>
            
            <div class="meta-item">
                <span>üë§</span>
                <strong>ÏûëÏÑ±Ïûê:</strong> {{ report.author.get_full_name|default:report.author.username }}
            </div>
            
            <div class="meta-item">
                <span>üìÖ</span>
                <strong>ÏûëÏÑ±Ïùº:</strong> {{ report.created_at|date:"YÎÖÑ mÏõî dÏùº H:i" }}
            </div>
            
            {% if report.submitted_at %}
            <div class="meta-item">
                <span>‚úÖ</span>
                <strong>Ï†úÏ∂úÏùº:</strong> {{ report.submitted_at|date:"YÎÖÑ mÏõî dÏùº H:i" }}
            </div>
            {% endif %}
            
            {% if report.is_offline %}
            <div class="meta-item">
                <span class="offline-badge">
                    <span>üì±</span>
                    <span>Ïò§ÌîÑÎùºÏù∏ ÏûëÏÑ±</span>
                </span>
            </div>
            {% endif %}
            
            {% if report.sync_status %}
            <div class="meta-item">
                <span class="sync-status">
                    <span>üîÑ</span>
                    <span>{{ report.sync_status }}</span>
                </span>
            </div>
            {% endif %}
            
            {% if report.notion_page_id %}
            <div class="meta-item">
                <span class="notion-sync">
                    <span>üìù</span>
                    <span>Notion ÎèôÍ∏∞ÌôîÎê®</span>
                </span>
            </div>
            {% endif %}
        </div>
        
        <!-- Ïï°ÏÖò Î≤ÑÌäºÎì§ -->
        <div class="action-buttons">
            <a href="{% url 'field_reports:report_list' %}" class="btn btn-secondary">
                <span>üìã</span>
                <span>Î™©Î°ù</span>
            </a>
            
            {% if user == report.author or user.is_staff %}
            <a href="{% url 'field_reports:report_edit' report.pk %}" class="btn btn-primary">
                <span>‚úèÔ∏è</span>
                <span>ÏàòÏ†ï</span>
            </a>
            
            {% if report.status == 'draft' %}
            <button onclick="submitReport()" class="btn btn-success">
                <span>üì§</span>
                <span>Ï†úÏ∂úÌïòÍ∏∞</span>
            </button>
            {% endif %}
            
            <button onclick="printReport()" class="btn btn-secondary">
                <span>üñ®Ô∏è</span>
                <span>Ïù∏ÏáÑ</span>
            </button>
            
            <button onclick="exportPDF()" class="btn btn-secondary">
                <span>üìÑ</span>
                <span>PDF Ï†ÄÏû•</span>
            </button>
            
            {% if user.is_staff %}
            <button onclick="confirmDelete()" class="btn btn-danger">
                <span>üóëÔ∏è</span>
                <span>ÏÇ≠Ï†ú</span>
            </button>
            {% endif %}
            {% endif %}
        </div>
    </div>
    
    <!-- ÌòÑÏû• Ï†ïÎ≥¥ ÏÑπÏÖò -->
    <div class="content-section">
        <h2 class="section-title">
            <span>üèóÔ∏è</span>
            <span>ÌòÑÏû• Ï†ïÎ≥¥</span>
        </h2>
        
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">ÌîÑÎ°úÏ†ùÌä∏Î™Ö</div>
                <div class="info-value">{{ report.project_name }}</div>
            </div>
            
            <div class="info-item">
                <div class="info-label">ÌòÑÏû•Î™Ö</div>
                <div class="info-value">{{ report.site_name }}</div>
            </div>
            
            {% if report.contractor %}
            <div class="info-item">
                <div class="info-label">ÎèÑÍ∏âÏÇ¨</div>
                <div class="info-value">{{ report.contractor }}</div>
            </div>
            {% endif %}
            
            {% if report.workers_count %}
            <div class="info-item">
                <div class="info-label">ÏûëÏóÖÏù∏Ïõê</div>
                <div class="info-value">{{ report.workers_count }}Î™Ö</div>
            </div>
            {% endif %}
        </div>
        
        {% if report.attendees %}
        <div class="info-item" style="margin-top: 16px;">
            <div class="info-label">Ï∞∏ÏÑùÏûê Î™ÖÎã®</div>
            <div class="info-value">{{ report.attendees }}</div>
        </div>
        {% endif %}
    </div>
    
    <!-- ÎÇ†Ïî® Ï†ïÎ≥¥ ÏÑπÏÖò -->
    {% if report.weather or report.temperature %}
    <div class="content-section">
        <h2 class="section-title">
            <span>‚òÅÔ∏è</span>
            <span>ÎÇ†Ïî® Ï†ïÎ≥¥</span>
        </h2>
        
        <div class="info-grid">
            {% if report.weather %}
            <div class="info-item">
                <div class="info-label">ÎÇ†Ïî®</div>
                <div class="info-value">
                    {% if report.weather == 'ÎßëÏùå' %}‚òÄÔ∏è{% elif report.weather == 'Íµ¨Î¶ÑÏ°∞Í∏à' %}‚õÖ{% elif report.weather == 'ÌùêÎ¶º' %}‚òÅÔ∏è{% elif report.weather == 'ÎπÑ' %}üåßÔ∏è{% elif report.weather == 'Îàà' %}‚ùÑÔ∏è{% elif report.weather == 'ÏïàÍ∞ú' %}üå´Ô∏è{% endif %}
                    {{ report.weather }}
                </div>
            </div>
            {% endif %}
            
            {% if report.temperature %}
            <div class="info-item">
                <div class="info-label">Ïò®ÎèÑ</div>
                <div class="info-value">{{ report.temperature }}</div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
    
    <!-- ÏúÑÏπò Ï†ïÎ≥¥ ÏÑπÏÖò -->
    {% if report.latitude and report.longitude %}
    <div class="content-section">
        <h2 class="section-title">
            <span>üìç</span>
            <span>ÏúÑÏπò Ï†ïÎ≥¥</span>
        </h2>
        
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">GPS Ï¢åÌëú</div>
                <div class="info-value">{{ report.latitude }}, {{ report.longitude }}</div>
            </div>
            
            {% if report.location_address %}
            <div class="info-item">
                <div class="info-label">Ï£ºÏÜå</div>
                <div class="info-value">{{ report.location_address }}</div>
            </div>
            {% endif %}
        </div>
        
        <div class="location-map" id="map">
            <span>üó∫Ô∏è ÏßÄÎèÑ ÏòÅÏó≠ (Íµ¨ÌòÑ ÏòàÏ†ï)</span>
        </div>
    </div>
    {% endif %}
    
    <!-- ÎÇ¥Ïö© ÏÑπÏÖò -->
    <div class="content-section">
        <h2 class="section-title">
            <span>üìù</span>
            <span>ÏÉÅÏÑ∏ ÎÇ¥Ïö©</span>
        </h2>
        
        <div class="content-text">{{ report.content }}</div>
    </div>
    
    <!-- Ï≤®Î∂ÄÌååÏùº ÏÑπÏÖò -->
    {% if report.attachments.exists %}
    <div class="content-section">
        <h2 class="section-title">
            <span>üìé</span>
            <span>Ï≤®Î∂ÄÌååÏùº ({{ report.attachments.count }}Í∞ú)</span>
        </h2>
        
        <div class="attachments-grid">
            {% for attachment in report.attachments.all %}
            <div class="attachment-item" onclick="viewAttachment('{{ attachment.file.url }}')">
                {% if attachment.file_type == 'image' %}
                    {% if attachment.thumbnail %}
                        <img src="{{ attachment.thumbnail.url }}" alt="{{ attachment.file_name }}" class="attachment-image">
                    {% else %}
                        <img src="{{ attachment.file.url }}" alt="{{ attachment.file_name }}" class="attachment-image">
                    {% endif %}
                {% else %}
                    <div style="height: 150px; display: flex; align-items: center; justify-content: center; background: #f5f5f7;">
                        {% if attachment.file_type == 'document' %}
                            <span style="font-size: 48px;">üìÑ</span>
                        {% elif attachment.file_type == 'video' %}
                            <span style="font-size: 48px;">üé•</span>
                        {% elif attachment.file_type == 'audio' %}
                            <span style="font-size: 48px;">üéµ</span>
                        {% else %}
                            <span style="font-size: 48px;">üìÅ</span>
                        {% endif %}
                    </div>
                {% endif %}
                
                <div class="attachment-info">
                    <div class="attachment-name">{{ attachment.file_name }}</div>
                    <div class="attachment-size">{{ attachment.file_size|filesizeformat }}</div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- Í≤ÄÌÜ† ÏùòÍ≤¨ ÏÑπÏÖò -->
    {% if report.review_comment %}
    <div class="content-section">
        <h2 class="section-title">
            <span>‚úçÔ∏è</span>
            <span>Í≤ÄÌÜ† ÏùòÍ≤¨</span>
        </h2>
        
        <div class="review-section">
            <div class="review-header">
                <div class="review-title">
                    Í≤ÄÌÜ†Ïûê: {{ report.reviewed_by.get_full_name|default:report.reviewed_by.username }}
                </div>
                <div class="review-meta">
                    {{ report.reviewed_at|date:"YÎÖÑ mÏõî dÏùº H:i" }}
                </div>
            </div>
            <div class="review-comment">{{ report.review_comment }}</div>
        </div>
    </div>
    {% endif %}
</div>

<script>
// Î¶¨Ìè¨Ìä∏ Ï†úÏ∂ú
function submitReport() {
    if (confirm('Î¶¨Ìè¨Ìä∏Î•º Ï†úÏ∂úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÏ†úÏ∂ú ÌõÑÏóêÎäî ÏàòÏ†ïÏù¥ Ï†úÌïúÎê©ÎãàÎã§.')) {
        fetch("{% url 'field_reports:report_edit' report.pk %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCsrfToken()
            },
            body: 'status=submitted&action=submit'
        }).then(response => {
            if (response.ok) {
                location.reload();
            }
        });
    }
}

// Î¶¨Ìè¨Ìä∏ ÏÇ≠Ï†ú
function confirmDelete() {
    if (confirm('Ï†ïÎßêÎ°ú Ïù¥ Î¶¨Ìè¨Ìä∏Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÏù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.')) {
        window.location.href = "{% url 'field_reports:report_delete' report.pk %}";
    }
}

// Ïù∏ÏáÑ
function printReport() {
    window.print();
}

// PDF ÎÇ¥Î≥¥ÎÇ¥Í∏∞ (Î∏åÎùºÏö∞Ï†Ä Ïù∏ÏáÑ Í∏∞Îä• ÌôúÏö©)
function exportPDF() {
    window.print();
}

// Ï≤®Î∂ÄÌååÏùº Î≥¥Í∏∞
function viewAttachment(url) {
    window.open(url, '_blank');
}

// CSRF ÌÜ†ÌÅ∞ Í∞ÄÏ†∏Ïò§Í∏∞
function getCsrfToken() {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrftoken') {
            return value;
        }
    }
    return '';
}

// ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî (Ï∂îÌõÑ Íµ¨ÌòÑ)
document.addEventListener('DOMContentLoaded', function() {
    {% if report.latitude and report.longitude %}
    // OpenStreetMap ÎòêÎäî Google Maps API Ïó∞Îèô
    // const lat = {{ report.latitude }};
    // const lng = {{ report.longitude }};
    // initMap(lat, lng);
    {% endif %}
});
</script>
{% endblock %}