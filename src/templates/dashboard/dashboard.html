{% extends 'base.html' %}
{% load static %}

{% block title %}대시보드 - OneSquare{% endblock %}

{% block extra_css %}
<style>
    /* 대시보드 고급 분석 스타일 */
    .dashboard-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .dashboard-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 30px;
    }
    
    .welcome-section h1 {
        font-size: 28px;
        margin-bottom: 8px;
    }
    
    .date-time {
        font-size: 16px;
        opacity: 0.9;
    }
    
    /* 통계 카드 개선 */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        border: 1px solid #e5e5ea;
        border-radius: 12px;
        padding: 20px;
        transition: all 0.3s;
        position: relative;
        overflow: hidden;
    }
    
    .stat-card:hover {
        box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        transform: translateY(-2px);
    }
    
    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
    }
    
    .stat-card:nth-child(1)::before { background: #007AFF; }
    .stat-card:nth-child(2)::before { background: #34C759; }
    .stat-card:nth-child(3)::before { background: #FFD60A; }
    .stat-card:nth-child(4)::before { background: #FF3B30; }
    
    .stat-value {
        font-size: 32px;
        font-weight: 700;
        color: #1d1d1f;
    }
    
    .stat-change {
        font-size: 13px;
        font-weight: 600;
        padding: 4px 8px;
        border-radius: 12px;
        display: inline-block;
    }
    
    .stat-change.positive {
        background: #e8f5e9;
        color: #2e7d32;
    }
    
    .stat-change.negative {
        background: #ffebee;
        color: #c62828;
    }
    
    /* CSS 차트 스타일 */
    .css-chart-container {
        background: white;
        border: 1px solid #e5e5ea;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .chart-header h2 {
        font-size: 18px;
        font-weight: 600;
        color: #1d1d1f;
    }
    
    /* CSS 바 차트 */
    .css-bar-chart {
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        height: 200px;
        gap: 12px;
    }
    
    .bar-item {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
    }
    
    .bar {
        width: 100%;
        background: linear-gradient(180deg, #007AFF 0%, #0051D5 100%);
        border-radius: 4px 4px 0 0;
        position: relative;
        transition: all 0.3s;
        cursor: pointer;
        min-height: 5px;
    }
    
    .bar:hover {
        opacity: 0.8;
        transform: translateY(-2px);
    }
    
    .bar-value {
        position: absolute;
        top: -20px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 12px;
        font-weight: 600;
        color: #1d1d1f;
        white-space: nowrap;
    }
    
    .bar-label {
        font-size: 12px;
        color: #6e6e73;
        text-align: center;
    }
    
    /* 실시간 데이터 테이블 */
    .data-table-container {
        background: white;
        border: 1px solid #e5e5ea;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 20px;
    }
    
    .table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #e5e5ea;
    }
    
    .data-table {
        width: 100%;
    }
    
    .data-table th {
        background: #f5f5f7;
        padding: 12px;
        text-align: left;
        font-size: 13px;
        font-weight: 600;
        color: #6e6e73;
        text-transform: uppercase;
    }
    
    .data-table td {
        padding: 12px;
        border-top: 1px solid #f5f5f7;
        font-size: 14px;
        color: #424245;
    }
    
    .data-table tbody tr:hover {
        background: #fafafa;
    }
    
    .status-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
    }
    
    .status-draft { background: #f0f0f5; color: #6e6e73; }
    .status-submitted { background: #e3f2fd; color: #1976d2; }
    .status-approved { background: #e8f5e9; color: #2e7d32; }
    .status-rejected { background: #ffebee; color: #c62828; }
</style>
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- 헤더 섹션 -->
    <div class="dashboard-header">
        <div class="welcome-section">
            <h1>안녕하세요, {{ user.first_name|default:user.username }}님!</h1>
            <p class="date-time" id="current-time">{{ current_time|date:"Y년 m월 d일 H:i" }}</p>
        </div>
        
        <div class="header-actions">
            <button class="btn-refresh" onclick="refreshDashboard()">
                <span class="refresh-icon">⟳</span> 새로고침
            </button>
            <div class="notification-dropdown">
                <button class="btn-notification" onclick="toggleNotifications()">
                    <span class="notification-icon">🔔</span>
                    <span class="notification-badge" id="notification-count">0</span>
                </button>
                <div class="notification-panel" id="notification-panel" style="display: none;">
                    <div class="notification-header">
                        <h3>알림</h3>
                        <button onclick="clearAllNotifications()">모두 읽음</button>
                    </div>
                    <div class="notification-list" id="notification-list">
                        <!-- 동적으로 알림 로드 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 통계 카드 섹션 (실시간 데이터) -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon users">👥</div>
            <div class="stat-content">
                <h3>전체 사용자</h3>
                <p class="stat-value" id="stat-users">{{ total_users }}</p>
                <span class="stat-change positive">+{{ new_users_week }}명 (이번주)</span>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon projects">📊</div>
            <div class="stat-content">
                <h3>전체 리포트</h3>
                <p class="stat-value" id="stat-projects">{{ total_reports }}</p>
                <span class="stat-change positive">+{{ reports_week }}개 (이번주)</span>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon tasks">✅</div>
            <div class="stat-content">
                <h3>제출된 리포트</h3>
                <p class="stat-value" id="stat-tasks">{{ status_distribution.submitted }}</p>
                <span class="stat-change positive">성장률 {{ growth_rate }}%</span>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon reports">📝</div>
            <div class="stat-content">
                <h3>작성중 리포트</h3>
                <p class="stat-value" id="stat-reports">{{ status_distribution.draft }}</p>
                <span class="stat-change">총 {{ reports_month }}개 (이번달)</span>
            </div>
        </div>
    </div>

    <!-- CSS 기반 차트 섹션 -->
    <div class="css-chart-container">
        <div class="chart-header">
            <h2>일별 리포트 현황</h2>
            <div class="chart-tabs">
                <button class="tab-btn active">최근 7일</button>
            </div>
        </div>
        
        <div class="css-bar-chart">
            {% for report in daily_reports %}
            <div class="bar-item">
                <div class="bar" style="height: {% if report.count > 0 %}{{ report.count|floatformat:0|add:20 }}%{% else %}5px{% endif %}">
                    <span class="bar-value">{{ report.count }}</span>
                </div>
                <span class="bar-label">{{ report.date }}</span>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- 최근 리포트 테이블 -->
    <div class="data-table-container">
        <div class="table-header">
            <h2>최근 리포트</h2>
            <a href="{% url 'field_reports:report_list' %}" style="color: #007AFF; text-decoration: none;">전체 보기 →</a>
        </div>
        
        <table class="data-table">
            <thead>
                <tr>
                    <th>제목</th>
                    <th>유형</th>
                    <th>작성자</th>
                    <th>상태</th>
                    <th>작성일</th>
                </tr>
            </thead>
            <tbody>
                {% for report in recent_reports %}
                <tr onclick="location.href='{% url 'field_reports:report_detail' report.pk %}'" style="cursor: pointer;">
                    <td>{{ report.title }}</td>
                    <td>{{ report.get_report_type_display }}</td>
                    <td>{{ report.author.get_full_name|default:report.author.username }}</td>
                    <td>
                        <span class="status-badge status-{{ report.status }}">
                            {{ report.get_status_display }}
                        </span>
                    </td>
                    <td>{{ report.created_at|date:"m/d H:i" }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" style="text-align: center; padding: 40px; color: #6e6e73;">
                        아직 작성된 리포트가 없습니다
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- 최근 활동 섹션 -->
    <div class="recent-activity-section">
        <div class="activity-container">
            <div class="section-header">
                <h2>최근 활동</h2>
                <button class="btn-view-all">전체 보기</button>
            </div>
            <div class="activity-list" id="activity-list">
                <!-- 동적으로 활동 로드 -->
            </div>
        </div>

        <!-- 빠른 작업 섹션 -->
        <div class="quick-actions">
            <h2>빠른 작업</h2>
            <div class="action-buttons">
                <button class="action-btn" onclick="createNewProject()">
                    <span class="action-icon">➕</span>
                    <span>새 프로젝트</span>
                </button>
                <button class="action-btn" onclick="createTask()">
                    <span class="action-icon">📝</span>
                    <span>작업 생성</span>
                </button>
                <button class="action-btn" onclick="generateReport()">
                    <span class="action-icon">📈</span>
                    <span>보고서 생성</span>
                </button>
                <button class="action-btn" onclick="viewCalendar()">
                    <span class="action-icon">📅</span>
                    <span>캘린더</span>
                </button>
                <button class="action-btn" onclick="teamManagement()">
                    <span class="action-icon">👥</span>
                    <span>팀 관리</span>
                </button>
                <button class="action-btn" onclick="viewSettings()">
                    <span class="action-icon">⚙️</span>
                    <span>설정</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 로딩 오버레이 -->
<div id="dashboard-loading" class="dashboard-loading" style="display: none;">
    <div class="spinner"></div>
    <p>데이터를 불러오는 중...</p>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="{% static 'js/dashboard.js' %}"></script>
<script>
// 페이지 로드 시 초기화
document.addEventListener('DOMContentLoaded', function() {
    initDashboard();
});
</script>
{% endblock %}