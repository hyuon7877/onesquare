{% extends 'base.html' %}
{% load static %}

{% block title %}ëŒ€ì‹œë³´ë“œ - OneSquare{% endblock %}

{% block extra_css %}
<style>
    /* ëŒ€ì‹œë³´ë“œ ê³ ê¸‰ ë¶„ì„ ìŠ¤íƒ€ì¼ */
    .dashboard-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .dashboard-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 30px;
    }
    
    .welcome-section h1 {
        font-size: 28px;
        margin-bottom: 8px;
    }
    
    .date-time {
        font-size: 16px;
        opacity: 0.9;
    }
    
    /* í†µê³„ ì¹´ë“œ ê°œì„  */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        border: 1px solid #e5e5ea;
        border-radius: 12px;
        padding: 20px;
        transition: all 0.3s;
        position: relative;
        overflow: hidden;
    }
    
    .stat-card:hover {
        box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        transform: translateY(-2px);
    }
    
    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
    }
    
    .stat-card:nth-child(1)::before { background: #007AFF; }
    .stat-card:nth-child(2)::before { background: #34C759; }
    .stat-card:nth-child(3)::before { background: #FFD60A; }
    .stat-card:nth-child(4)::before { background: #FF3B30; }
    
    .stat-value {
        font-size: 32px;
        font-weight: 700;
        color: #1d1d1f;
    }
    
    .stat-change {
        font-size: 13px;
        font-weight: 600;
        padding: 4px 8px;
        border-radius: 12px;
        display: inline-block;
    }
    
    .stat-change.positive {
        background: #e8f5e9;
        color: #2e7d32;
    }
    
    .stat-change.negative {
        background: #ffebee;
        color: #c62828;
    }
    
    /* CSS ì°¨íŠ¸ ìŠ¤íƒ€ì¼ */
    .css-chart-container {
        background: white;
        border: 1px solid #e5e5ea;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .chart-header h2 {
        font-size: 18px;
        font-weight: 600;
        color: #1d1d1f;
    }
    
    /* CSS ë°” ì°¨íŠ¸ */
    .css-bar-chart {
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        height: 200px;
        gap: 12px;
    }
    
    .bar-item {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
    }
    
    .bar {
        width: 100%;
        background: linear-gradient(180deg, #007AFF 0%, #0051D5 100%);
        border-radius: 4px 4px 0 0;
        position: relative;
        transition: all 0.3s;
        cursor: pointer;
        min-height: 5px;
    }
    
    .bar:hover {
        opacity: 0.8;
        transform: translateY(-2px);
    }
    
    .bar-value {
        position: absolute;
        top: -20px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 12px;
        font-weight: 600;
        color: #1d1d1f;
        white-space: nowrap;
    }
    
    .bar-label {
        font-size: 12px;
        color: #6e6e73;
        text-align: center;
    }
    
    /* ì‹¤ì‹œê°„ ë°ì´í„° í…Œì´ë¸” */
    .data-table-container {
        background: white;
        border: 1px solid #e5e5ea;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 20px;
    }
    
    .table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #e5e5ea;
    }
    
    .data-table {
        width: 100%;
    }
    
    .data-table th {
        background: #f5f5f7;
        padding: 12px;
        text-align: left;
        font-size: 13px;
        font-weight: 600;
        color: #6e6e73;
        text-transform: uppercase;
    }
    
    .data-table td {
        padding: 12px;
        border-top: 1px solid #f5f5f7;
        font-size: 14px;
        color: #424245;
    }
    
    .data-table tbody tr:hover {
        background: #fafafa;
    }
    
    .status-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
    }
    
    .status-draft { background: #f0f0f5; color: #6e6e73; }
    .status-submitted { background: #e3f2fd; color: #1976d2; }
    .status-approved { background: #e8f5e9; color: #2e7d32; }
    .status-rejected { background: #ffebee; color: #c62828; }
</style>
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- í—¤ë” ì„¹ì…˜ -->
    <div class="dashboard-header">
        <div class="welcome-section">
            <h1>ì•ˆë…•í•˜ì„¸ìš”, {{ user.first_name|default:user.username }}ë‹˜!</h1>
            <p class="date-time" id="current-time">{{ current_time|date:"Yë…„ mì›” dì¼ H:i" }}</p>
        </div>
        
        <div class="header-actions">
            <button class="btn-refresh" onclick="refreshDashboard()">
                <span class="refresh-icon">âŸ³</span> ìƒˆë¡œê³ ì¹¨
            </button>
            <div class="notification-dropdown">
                <button class="btn-notification" onclick="toggleNotifications()">
                    <span class="notification-icon">ğŸ””</span>
                    <span class="notification-badge" id="notification-count">0</span>
                </button>
                <div class="notification-panel" id="notification-panel" style="display: none;">
                    <div class="notification-header">
                        <h3>ì•Œë¦¼</h3>
                        <button onclick="clearAllNotifications()">ëª¨ë‘ ì½ìŒ</button>
                    </div>
                    <div class="notification-list" id="notification-list">
                        <!-- ë™ì ìœ¼ë¡œ ì•Œë¦¼ ë¡œë“œ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- í†µê³„ ì¹´ë“œ ì„¹ì…˜ (ì‹¤ì‹œê°„ ë°ì´í„°) -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon users">ğŸ‘¥</div>
            <div class="stat-content">
                <h3>ì „ì²´ ì‚¬ìš©ì</h3>
                <p class="stat-value" id="stat-users">{{ total_users }}</p>
                <span class="stat-change positive">+{{ new_users_week }}ëª… (ì´ë²ˆì£¼)</span>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon projects">ğŸ“Š</div>
            <div class="stat-content">
                <h3>ì „ì²´ ë¦¬í¬íŠ¸</h3>
                <p class="stat-value" id="stat-projects">{{ total_reports }}</p>
                <span class="stat-change positive">+{{ reports_week }}ê°œ (ì´ë²ˆì£¼)</span>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon tasks">âœ…</div>
            <div class="stat-content">
                <h3>ì œì¶œëœ ë¦¬í¬íŠ¸</h3>
                <p class="stat-value" id="stat-tasks">{{ status_distribution.submitted }}</p>
                <span class="stat-change positive">ì„±ì¥ë¥  {{ growth_rate }}%</span>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon reports">ğŸ“</div>
            <div class="stat-content">
                <h3>ì‘ì„±ì¤‘ ë¦¬í¬íŠ¸</h3>
                <p class="stat-value" id="stat-reports">{{ status_distribution.draft }}</p>
                <span class="stat-change">ì´ {{ reports_month }}ê°œ (ì´ë²ˆë‹¬)</span>
            </div>
        </div>
    </div>

    <!-- CSS ê¸°ë°˜ ì°¨íŠ¸ ì„¹ì…˜ -->
    <div class="css-chart-container">
        <div class="chart-header">
            <h2>ì¼ë³„ ë¦¬í¬íŠ¸ í˜„í™©</h2>
            <div class="chart-tabs">
                <button class="tab-btn active">ìµœê·¼ 7ì¼</button>
            </div>
        </div>
        
        <div class="css-bar-chart">
            {% for report in daily_reports %}
            <div class="bar-item">
                <div class="bar" style="height: {% if report.count > 0 %}{{ report.count|floatformat:0|add:20 }}%{% else %}5px{% endif %}">
                    <span class="bar-value">{{ report.count }}</span>
                </div>
                <span class="bar-label">{{ report.date }}</span>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- ìµœê·¼ ë¦¬í¬íŠ¸ í…Œì´ë¸” -->
    <div class="data-table-container">
        <div class="table-header">
            <h2>ìµœê·¼ ë¦¬í¬íŠ¸</h2>
            <a href="{% url 'field_reports:report_list' %}" style="color: #007AFF; text-decoration: none;">ì „ì²´ ë³´ê¸° â†’</a>
        </div>
        
        <table class="data-table">
            <thead>
                <tr>
                    <th>ì œëª©</th>
                    <th>ìœ í˜•</th>
                    <th>ì‘ì„±ì</th>
                    <th>ìƒíƒœ</th>
                    <th>ì‘ì„±ì¼</th>
                </tr>
            </thead>
            <tbody>
                {% for report in recent_reports %}
                <tr onclick="location.href='{% url 'field_reports:report_detail' report.pk %}'" style="cursor: pointer;">
                    <td>{{ report.title }}</td>
                    <td>{{ report.get_report_type_display }}</td>
                    <td>{{ report.author.get_full_name|default:report.author.username }}</td>
                    <td>
                        <span class="status-badge status-{{ report.status }}">
                            {{ report.get_status_display }}
                        </span>
                    </td>
                    <td>{{ report.created_at|date:"m/d H:i" }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" style="text-align: center; padding: 40px; color: #6e6e73;">
                        ì•„ì§ ì‘ì„±ëœ ë¦¬í¬íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- ìµœê·¼ í™œë™ ì„¹ì…˜ -->
    <div class="recent-activity-section">
        <div class="activity-container">
            <div class="section-header">
                <h2>ìµœê·¼ í™œë™</h2>
                <button class="btn-view-all">ì „ì²´ ë³´ê¸°</button>
            </div>
            <div class="activity-list" id="activity-list">
                <!-- ë™ì ìœ¼ë¡œ í™œë™ ë¡œë“œ -->
            </div>
        </div>

        <!-- ë¹ ë¥¸ ì‘ì—… ì„¹ì…˜ -->
        <div class="quick-actions">
            <h2>ë¹ ë¥¸ ì‘ì—…</h2>
            <div class="action-buttons">
                <button class="action-btn" onclick="createNewProject()">
                    <span class="action-icon">â•</span>
                    <span>ìƒˆ í”„ë¡œì íŠ¸</span>
                </button>
                <button class="action-btn" onclick="createTask()">
                    <span class="action-icon">ğŸ“</span>
                    <span>ì‘ì—… ìƒì„±</span>
                </button>
                <button class="action-btn" onclick="generateReport()">
                    <span class="action-icon">ğŸ“ˆ</span>
                    <span>ë³´ê³ ì„œ ìƒì„±</span>
                </button>
                <button class="action-btn" onclick="viewCalendar()">
                    <span class="action-icon">ğŸ“…</span>
                    <span>ìº˜ë¦°ë”</span>
                </button>
                <button class="action-btn" onclick="teamManagement()">
                    <span class="action-icon">ğŸ‘¥</span>
                    <span>íŒ€ ê´€ë¦¬</span>
                </button>
                <button class="action-btn" onclick="viewSettings()">
                    <span class="action-icon">âš™ï¸</span>
                    <span>ì„¤ì •</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
<div id="dashboard-loading" class="dashboard-loading" style="display: none;">
    <div class="spinner"></div>
    <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="{% static 'js/dashboard.js' %}"></script>
<script>
// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    initDashboard();
});
</script>
{% endblock %}